    case 'eraseTier':{const tgt=~~(Math.random()*(Math.min(GM.levelDef.maxTier,8)+1));GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&t.tier===tgt)GM.grid[r][c]=randTile(GM.levelDef);}));showNotif(`ğŸ—‘ï¸ Â¡${ING[tgt].e} eliminados!`);break;}
    case 'eraseTwo':{[~~(Math.random()*6),~~(Math.random()*6)].forEach(tgt=>GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&t.tier===tgt)GM.grid[r][c]=randTile(GM.levelDef);})));break;}
    case 'eraseThree':{[~~(Math.random()*6),~~(Math.random()*6),~~(Math.random()*6)].forEach(tgt=>GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&t.tier===tgt)GM.grid[r][c]=randTile(GM.levelDef);})));break;}
    case 'timeRevert':{GM.grid=buildGrid(GM.levelDef);showNotif('â†©ï¸ Â¡El tablero regresa!');break;}
    case 'doubleRules':{showNotif('ğŸ“„ Â¡Los poderes cuestan el doble esta ronda!');break;}
    case 'freezeAndShield':{const r1r=~~(Math.random()*rows),r2r=~~(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r1r]?.[c])GM.grid[r1r][c].frozen=true;if(GM.grid[r2r]?.[c])GM.grid[r2r][c].shield=true;}break;}
    case 'invertShuffle':{GM.grid.flat().forEach(t=>{if(t)t.tier=Math.max(0,GM.levelDef.maxTier-t.tier);});const flat=GM.grid.flat().sort(()=>Math.random()-.5);let i=0;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)GM.grid[r][c]=flat[i++]||randTile(GM.levelDef);break;}
    case 'invertAndFreeze':{GM.grid.flat().forEach(t=>{if(t){t.tier=Math.max(0,GM.levelDef.maxTier-t.tier);if(Math.random()<.35)t.frozen=true;}});break;}
    case 'invertAndCurse':{GM.grid.flat().forEach(t=>{if(t){t.tier=Math.max(0,GM.levelDef.maxTier-t.tier);if(Math.random()<.35)t.cursed=true;}});break;}
    case 'allDegrade':{GM.grid.flat().forEach(t=>{if(t&&t.tier>0&&!t.shield)t.tier--;});break;}
    case 'vortex':{const cx=~~(cols/2),cy=~~(rows/2);GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(Math.abs(r-cy)+Math.abs(c-cx)<=2&&t&&!t.shield)GM.grid[r][c]=randTile(GM.levelDef);}));break;}
    case 'summonMinion':{for(let i=0;i<2;i++){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c])GM.grid[r][c].shield=true;}showNotif(`ğŸ‘¤ Â¡Invoca un aliado!`);break;}
    case 'supremeAttack':{let n=0;while(n<10){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}showNotif('ğŸ’¥ Â¡ATAQUE SUPREMO! âˆ’10 ingredientes!');break;}
    case 'theFracture':{let n=0;while(n<8){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'sevenDestroy':{let n=0;while(n<7){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'nineDestroy':{let n=0;while(n<9){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'twelveDestroy':{let n=0;while(n<12){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'fourteenDestroy':{let n=0;while(n<14){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'fifteenDestroy':{let n=0;while(n<15){const r=~~(Math.random()*rows),c=~~(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'randomEffect':{const effects=['freezeRow','curseTwo','witherTwo','addShields','degradeShuffle'];const pick=effects[~~(Math.random()*effects.length)];executeRivalAttackById(pick);break;}
  }
  renderGrid();updateHUD();
}

function executeRivalAttackById(id){
  const fake={id};GM.rival.attacks=[fake];executeRivalAttack();GM.rival.attacks=RIVALS.find(r=>r.level===GM.level)?.attacks||[];
}

function flashRivalAttack(){
  const d=document.createElement('div');d.className='rival-attack-overlay';document.body.appendChild(d);setTimeout(()=>d.remove(),600);
}

function updateRivalHp(){
  const pct=GM.rivalHp/GM.rivalMaxHp;
  document.getElementById('rivalHpFill').style.width=(pct*100)+'%';
  document.getElementById('rivalHpVal').textContent=`${GM.rivalHp}/${GM.rivalMaxHp}`;
  document.getElementById('rivalHpFill').style.background=pct>.5?'linear-gradient(90deg,#7f1d1d,#ef4444,#fca5a5)':pct>.25?'linear-gradient(90deg,#92400e,#f59e0b)':'linear-gradient(90deg,#fbbf24,#fff)';
  updateObjProgress(0);
}

function updateHUD(){
  document.getElementById('hScore').textContent=GM.score.toLocaleString();
  document.getElementById('hMoves').textContent=GM.moves;
  document.getElementById('hLevel').textContent=GM.level;
  const pct=GM.moves/GM.maxMoves;
  document.getElementById('mvArc').style.strokeDashoffset=(125.7*(1-pct)).toFixed(1);
  document.getElementById('hMoves').className='mv-txt'+(GM.moves<=5?' moves-low':'');
}

function selPu(type){
  if(G.powerups[type]<=0){showNotif('âŒ Sin este utensilio. Â¡Visita la tienda!');sfxFail();return;}
  if(GM.activePu===type){GM.activePu=null;document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));return;}
  GM.activePu=type;
  document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));
  const key='pu'+type.charAt(0).toUpperCase()+type.slice(1);
  document.getElementById(key)?.classList.add('act');
  const msgs={rodillo:'ğŸ‚ Toca para destruir un ingrediente',batidora:'ğŸ”€ Mezclando tablero...',levadura:'â¬†ï¸ Toca para subir un tier',extra:'â° +5 turnos aÃ±adidos'};
  showNotif(msgs[type]);
  if(type==='batidora'||type==='extra')applyPu(type,-1,-1);
  else sfxPu();
}
function applyPu(type,r,c){
  G.powerups[type]--;GM.activePu=null;
  document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));
  updatePuBar();sfxPu();
  if(type==='rodillo'&&r>=0){GM.grid[r][c]=randTile(GM.levelDef);showNotif('ğŸ‚ Â¡Ingrediente destruido!');}
  else if(type==='batidora'){const flat=GM.grid.flat().sort(()=>Math.random()-.5);let i=0;for(let rr=0;rr<GM.rows;rr++)for(let cc=0;cc<GM.cols;cc++)GM.grid[rr][cc]=flat[i++]||randTile(GM.levelDef);showNotif('ğŸ”€ Â¡Tablero mezclado!');}
  else if(type==='levadura'&&r>=0){const t=GM.grid[r][c];if(t){t.tier=Math.min(t.tier+1,ING.length-1);t.frozen=false;showNotif(`â¬†ï¸ Â¡${ING[t.tier].n} listo!`);}}
  else if(type==='extra'){GM.moves+=5;GM.maxMoves+=5;showNotif('â° Â¡+5 turnos!');}
  renderGrid();updateHUD();saveG();
}
function updatePuBar(){
  ['Rodillo','Batidora','Levadura','Extra'].forEach(k=>{
    const el=document.getElementById('pu'+k+'N');if(el)el.textContent=G.powerups[k.toLowerCase()]||0;
  });
}

// WIN / LOSE
function levelWin(){
  sfxWin();
  const prev=G.bestScores[GM.level]||0;
  if(GM.score>prev)G.bestScores[GM.level]=GM.score;
  if(GM.level>=G.unlocked&&GM.level<MAX_LEVEL)G.unlocked=GM.level+1;
  const coinB=Math.floor(GM.score/200)+10;G.coins+=coinB;
  const moveRatio=GM.moves/GM.maxMoves;
  const stars=moveRatio>.5?3:moveRatio>.2?2:1;
  if(!G.starsEarned[GM.level]||stars>G.starsEarned[GM.level])G.starsEarned[GM.level]=stars;
  G.currentChapter=Math.max(G.currentChapter,GM.levelDef.chap.id);
  saveG();sfxCoin();
  document.getElementById('resStars').textContent='â­'.repeat(stars)+'â˜†'.repeat(3-stars);
  document.getElementById('resScore').textContent=GM.score.toLocaleString()+' pts';
  document.getElementById('resBest').textContent=GM.score>prev?'ğŸ† Â¡NUEVO RÃ‰CORD!':'MEJOR: '+prev.toLocaleString();
  document.getElementById('resBonus').textContent=`+ğŸª™${coinB} monedas`;
  showPanel('winPanel');
}

function rivalWin(){
  sfxWin();sfxWin();
  const rival=GM.rival;G.rivalKills++;
  if(GM.level>=G.unlocked&&GM.level<MAX_LEVEL)G.unlocked=GM.level+1;
  const coinB=80+Math.floor(GM.level/30)*40;const gemB=12+Math.floor(GM.level/30)*4;
  G.coins+=coinB;G.gems+=gemB;
  G.bestScores[GM.level]=GM.score;G.starsEarned[GM.level]=3;
  G.currentChapter=Math.max(G.currentChapter,GM.levelDef.chap.id);
  saveG();sfxCoin();sfxCoin();
  document.getElementById('rwTitle').textContent=`Â¡${rival.name} superado!`;
  document.getElementById('rwSub').textContent=rival.title.toUpperCase();
  document.getElementById('rwStars').textContent='â­â­â­';
  document.getElementById('rwScore').textContent=GM.score.toLocaleString()+' pts';
  document.getElementById('rwBonus').textContent=`+ğŸª™${coinB} +ğŸ’${gemB}`;
  document.getElementById('rwLore').textContent=rival.winLore;
  showPanel('rivalWinPanel');
}

function triggerLose(){
  sfxFail();
  document.getElementById('goScore').textContent=GM.score.toLocaleString()+' pts';
  showPanel('losePanel');
}

// LEVEL FLOW
function startLevel(num){
  hideAllPanels();
  GM.level=num;GM.score=0;GM.combo=0;GM.selected=null;GM.activePu=null;GM.comboAbsorbed=false;
  GM.levelDef=buildLvlDef(num);
  GM.isRival=GM.levelDef.isRival;GM.rival=GM.levelDef.rival||null;
  GM.objective=GM.levelDef.objective;GM.objProgress=0;
  GM.moves=GM.levelDef.moves;GM.maxMoves=GM.levelDef.moves;
  GM.rows=5;GM.cols=GM.levelDef.isRival?6:5;
  GM.grid=buildGrid(GM.levelDef);
  if(GM.isRival&&GM.rival){GM.rivalHp=GM.rival.hp;GM.rivalMaxHp=GM.rival.hp;GM.rivalAttackIn=3;}
  hideAllScreens();showScreen('gameScreen');
  const rBar=document.getElementById('rivalHpBar');
  if(GM.isRival&&GM.rival){
    rBar.style.display='block';
    document.getElementById('rivalHpName').textContent=`${GM.rival.icon} ${GM.rival.name}`;
    updateRivalHp();
  } else {rBar.style.display='none';}
  document.getElementById('objBanner').innerHTML=
    `<div class="obj-t">${GM.objective.text}</div>
     <div class="obj-p" id="objPrg">0/${GM.objective.target.toLocaleString()}</div>
     <div class="obj-prog-bar"><div class="obj-prog-fill" id="objFill" style="width:0%"></div></div>`;
  updateHUD();updatePuBar();renderGrid();
  if(GM.isRival)showNotif(`âš”ï¸ Â¡Reto de ${GM.rival?.name}!`);
}

function nextLvl(){
  hideAllPanels();
  const next=Math.min(GM.level+1,MAX_LEVEL);
  const story=ALL_STORIES[next];
  if(story&&!G.storiesSeen[next]){
    G.storiesSeen[next]=true;saveG();
    showStory(story,()=>checkRivalIntro(next));
  } else {
    checkRivalIntro(next);
  }
}

function checkRivalIntro(lvl){
  const rival=RIVALS.find(r=>r.level===lvl);
  if(rival&&!G.storiesSeen['rival_'+lvl]){
    G.storiesSeen['rival_'+lvl]=true;saveG();
    showRivalIntro(rival,()=>startLevel(lvl));
  } else startLevel(lvl);
}

function replayLvl(){hideAllPanels();startLevel(GM.level);}
function buyMoves(){if(G.gems>=20){G.gems-=20;GM.moves+=5;GM.maxMoves+=5;saveG();hidePanel('losePanel');updateHUD();showNotif('â° +5 turnos!');}else{showNotif('ğŸ’ Sin gemas. Â¡Visita la tienda!');sfxFail();}}
function watchAd(){showNotif('ğŸ“º Cargando anuncio...');setTimeout(()=>{GM.moves+=3;GM.maxMoves+=3;hidePanel('losePanel');updateHUD();showNotif('âœ… Â¡+3 turnos gratis!');},1600);}
function confirmQuit(){showPanel('quitPanel');}
function doQuit(){hideAllPanels();goChapters();}

// CHAPTER / LEVEL SELECT
function goChapters(){
  hideAllPanels();hideAllScreens();showScreen('chapterScreen');
  const cont=document.getElementById('chapterCards');cont.innerHTML='';
  CHAPTERS.forEach(ch=>{
    const isLocked=G.unlocked<ch.levels[0];
    const progress=Object.keys(G.bestScores).filter(k=>+k>=ch.levels[0]&&+k<=ch.levels[1]).length;
    const total=ch.levels[1]-ch.levels[0]+1;
    const div=document.createElement('div');
    div.className='chap-card'+(isLocked?' locked':'');
    div.style.background=`linear-gradient(135deg,${ch.bg},rgba(40,0,60,.85))`;
    div.innerHTML=`<div class="chap-icon">${ch.icon}</div>
      <div class="chap-info">
        <div class="chap-num">CAPÃTULO ${ch.id} Â· Nv.${ch.levels[0]}â€“${ch.levels[1]}</div>
        <div class="chap-name">${ch.name}</div>
        <div class="chap-desc">${ch.desc}</div>
        ${!isLocked?`<div class="chap-prog">${progress}/${total} recetas completadas</div>`:''}
      </div>`;
    if(!isLocked)div.addEventListener('click',()=>goLevelSelect(ch));
    cont.appendChild(div);
  });
}

function goLevelSelect(chap){
  hideAllScreens();showScreen('levelScreen');
  document.getElementById('levelScreenTitle').textContent=`${chap.icon} ${chap.name}`;
  const grid=document.getElementById('lvlGrid');grid.innerHTML='';
  for(let i=chap.levels[0];i<=chap.levels[1];i++){
    const locked=i>G.unlocked;const completed=!!G.bestScores[i];
    const isRival=i===chap.rivalLevel;
    const btn=document.createElement('div');
    btn.className=`lvl-btn${locked?' locked':completed?' completed':' unlocked'}${isRival?' rival-lvl':''}`;
    const stars=G.starsEarned[i]||0;
    btn.innerHTML=`<div class="lvl-ico">${locked?'ğŸ”’':isRival?'âš”ï¸':ING[Math.min(~~(i/20),ING.length-1)].e}</div>
      <div class="lvl-n" style="${isRival?'color:#f87171;font-weight:800':''}">${isRival?'RETO':i}</div>
      <div class="lvl-stars">${completed?'â­'.repeat(stars)+'â˜†'.repeat(3-stars):''}</div>`;
    if(!locked)btn.addEventListener('click',()=>{
      const rival=RIVALS.find(r=>r.level===i);
      if(rival&&!G.storiesSeen['rival_'+i]){
        G.storiesSeen['rival_'+i]=true;saveG();
        showRivalIntro(rival,()=>startLevel(i));
      } else {
        const story=ALL_STORIES[i];
        if(story&&!G.storiesSeen[i]){G.storiesSeen[i]=true;saveG();showStory(story,()=>startLevel(i));}
        else startLevel(i);
      }
    });
    grid.appendChild(btn);
  }
}

// STORY / RIVAL INTRO
let storyCB=null;
function showStory(data,cb){
  storyCB=cb||null;
  document.getElementById('stEpisode').textContent=data.ep||'HISTORIA';
  document.getElementById('stIcon').textContent=data.icon||'ğŸ ';
  document.getElementById('stTitle').textContent=data.title||'';
  document.getElementById('stText').textContent=data.text||'';
  document.getElementById('stQuote').textContent=data.quote||'';
  hideAllScreens();showScreen('storyScreen');
}
function dismissStory(){const cb=storyCB;storyCB=null;if(cb)cb();else goMenu();}

let rivalIntroCB=null;
function showRivalIntro(rival,cb){
  rivalIntroCB=cb||null;
  document.getElementById('riIcon').textContent=rival.icon;
  document.getElementById('riName').textContent=rival.name;
  document.getElementById('riTitle').textContent=rival.title;
  document.getElementById('riLore').textContent=rival.lore;
  const ab=document.getElementById('riAbilities');ab.innerHTML='';
  rival.attacks.forEach(a=>{
    const d=document.createElement('div');d.className='rival-ability';
    d.innerHTML=`<div class="ra-icon">${a.emoji}</div><div><div class="ra-text">${a.name}</div><div class="ra-desc">${a.desc}</div></div>`;
    ab.appendChild(d);
  });
  hideAllScreens();showScreen('rivalIntroScreen');
}
function dismissRivalIntro(){const cb=rivalIntroCB;rivalIntroCB=null;if(cb)cb();else goMenu();}

// SHOP
const SHOP=[
  {section:'ğŸ’ GEMAS',items:[
    {icon:'ğŸ’',name:'Bolsita',desc:'50 gemas',price:'$0.99',action:'g50'},
    {icon:'ğŸ’ğŸ’',name:'Tarrito',desc:'200 gemas +BONUS',price:'$2.99',action:'g200',pop:true},
    {icon:'ğŸº',name:'Bote Grande',desc:'600 gemas +Ã‰PICO',price:'$9.99',action:'g600',feat:true},
    {icon:'ğŸŒŸ',name:'ColecciÃ³n',desc:'2000 gemas +MEGA',price:'$24.99',action:'g2000'},
  ]},
  {section:'ğŸª™ MONEDAS',items:[
    {icon:'ğŸª™',name:'PuÃ±ado',desc:'1.000 monedas',price:'$0.99',action:'c1k'},
    {icon:'ğŸ’°',name:'Saquito',desc:'5.000 monedas',price:'$3.99',action:'c5k',pop:true},
    {icon:'ğŸ†',name:'Tesoro',desc:'20.000 monedas',price:'$9.99',action:'c20k',feat:true},
  ]},
  {section:'ğŸ´ UTENSILIOS',items:[
    {icon:'ğŸ‚',name:'Rodillo Ã—5',desc:'Destruye 1 ingrediente',gems:30,action:'pr5'},
    {icon:'ğŸ”€',name:'Batidora Ã—3',desc:'Mezcla el tablero',gems:25,action:'pb3'},
    {icon:'â¬†ï¸',name:'Levadura Ã—5',desc:'Sube 1 tier',gems:35,action:'pl5',pop:true},
    {icon:'â°',name:'Tiempo Ã—3',desc:'+5 turnos por uso',gems:20,action:'pe3'},
  ]},
  {section:'ğŸ PAQUETES',items:[
    {icon:'ğŸ',name:'Pack Inicio',desc:'200ğŸ’+5kğŸª™+utensilios',price:'$1.99',action:'starter',feat:true,pop:true},
    {icon:'ğŸ‘‘',name:'Chef Pass',desc:'Recompensas diarias Ã©picas',price:'$4.99/mes',action:'season'},
    {icon:'â™¾ï¸',name:'Sin Anuncios',desc:'Experiencia pura',price:'$2.99',action:'noads'},
    {icon:'ğŸŒŸ',name:'Pack VIP',desc:'Todo incluido Â· 600 niveles',price:'$19.99',action:'vip',feat:true},
  ]},
];
function goShop(){
  hideAllPanels();hideAllScreens();showScreen('shopScreen');
  document.getElementById('sCoins').textContent=G.coins.toLocaleString();
  document.getElementById('sGems').textContent=G.gems;
  buildShop();
}
function buildShop(){
  const sc=document.getElementById('shopContent');sc.innerHTML='';
  SHOP.forEach(sec=>{
    const s=document.createElement('div');s.className='shop-sec';
    s.innerHTML=`<div class="shop-sec-title">${sec.section}</div>`;
    const row=document.createElement('div');row.className='shop-row';
    sec.items.forEach(item=>{
      const d=document.createElement('div');
      d.className='shop-card'+(item.feat?' feat':'')+(item.pop?' pop':'');
      d.innerHTML=`<div class="sc-icon">${item.icon}</div><div class="sc-name">${item.name}</div><div class="sc-desc">${item.desc}</div><div class="sc-price">${item.price||(item.gems?'ğŸ’'+item.gems:'')}</div>`;
      d.onclick=()=>handleBuy(item);row.appendChild(d);
    });
    s.appendChild(row);sc.appendChild(s);
  });
}
function handleBuy(item){
  if(item.gems){
    if(G.gems<item.gems){showNotif('ğŸ’ Sin gemas. Â¡Visita la tienda!');sfxFail();return;}
    G.gems-=item.gems;
    if(item.action==='pr5')G.powerups.rodillo+=5;
    else if(item.action==='pb3')G.powerups.batidora+=3;
    else if(item.action==='pl5')G.powerups.levadura+=5;
    else if(item.action==='pe3')G.powerups.extra+=3;
    showNotif(`âœ… Â¡${item.name} aÃ±adido!`);sfxCoin();saveG();buildShop();
    document.getElementById('sGems').textContent=G.gems;return;
  }
  showNotif('ğŸ§ Procesando pedido...');
  setTimeout(()=>{
    ({g50:()=>G.gems+=50,g200:()=>G.gems+=200,g600:()=>G.gems+=600,g2000:()=>G.gems+=2000,
      c1k:()=>G.coins+=1000,c5k:()=>G.coins+=5500,c20k:()=>G.coins+=25000,
      starter:()=>{G.gems+=200;G.coins+=5000;G.powerups.rodillo+=3;G.powerups.levadura+=3;G.powerups.batidora+=2;},
      season:()=>showNotif('ğŸ‘‘ Chef Pass activado!'),noads:()=>showNotif('â™¾ï¸ Â¡Sin anuncios!'),
      vip:()=>{G.gems+=1000;G.coins+=50000;Object.keys(G.powerups).forEach(k=>G.powerups[k]+=10);}
    })[item.action]?.();
    sfxWin();saveG();
    document.getElementById('sCoins').textContent=G.coins.toLocaleString();
    document.getElementById('sGems').textContent=G.gems;
    buildShop();showNotif(`âœ… Â¡${item.name} recibido! ğŸ‚`);
  },1200);
}

// STATS
function goStats(){
  hideAllPanels();hideAllScreens();showScreen('statsScreen');
  const lvls=Object.keys(G.bestScores).length;
  const stars=Object.values(G.starsEarned).reduce((a,b)=>a+b,0);
  const rows=[
    ['Recetas completadas',`${lvls}/${MAX_LEVEL}`],
    ['CapÃ­tulos desbloqueados',`${G.currentChapter}/20`],
    ['Rivales derrotados',`${G.rivalKills}/${RIVALS.length} ğŸ†`],
    ['Estrellas ganadas',`${stars}â­`],
    ['Fusiones totales',G.totalMerges.toLocaleString()],
    ['PuntuaciÃ³n total',G.totalScore.toLocaleString()],
    ['Mejor combo',`Ã—${G.bestCombo}`],
    ['Monedas acumuladas',G.coins.toLocaleString()],
    ['Racha de dÃ­as',`${G.streak}ğŸ”¥`],
  ];
  document.getElementById('statRows').innerHTML=rows.map(([l,v])=>
    `<div class="stat-row"><span class="sl">${l}</span><span class="sv">${v}</span></div>`).join('');
}

// DAILY
const DAILY=[
  {day:1,icon:'ğŸª™',val:'+300'},{day:2,icon:'ğŸ’',val:'+10'},{day:3,icon:'ğŸ‚',val:'Rodillo Ã—3'},
  {day:4,icon:'ğŸª™',val:'+1.200'},{day:5,icon:'â¬†ï¸',val:'Levadura Ã—3'},{day:6,icon:'ğŸ’',val:'+30'},
  {day:7,icon:'ğŸŒŸ',val:'ESPECIAL 150ğŸ’+5kğŸª™'},
];
function goDaily(){
  hideAllPanels();hideAllScreens();showScreen('dailyScreen');
  const today=new Date().toDateString();
  const grid3=document.getElementById('dailyGrid');grid3.innerHTML='';
  DAILY.forEach((r,i)=>{
    const claimed=G.streak>i;const isToday=G.streak===i&&G.lastLogin!==today;
    const d=document.createElement('div');
    d.className=`day-box${claimed?' claimed':''}${isToday?' today':''}`;
    d.innerHTML=`<div class="dl">DÃ­a ${i+1}</div><div class="di">${r.icon}</div><div class="dv">${r.val}</div>${claimed?'<div style="font-size:9px;color:#34d399">âœ“</div>':''}`;
    grid3.appendChild(d);
  });
  const alreadyClaimed=G.lastLogin===new Date().toDateString();
  const btn=document.getElementById('claimBtn');
  btn.textContent=alreadyClaimed?'âœ… YA RECOGIDO HOY':'ğŸ‚ RECOGER RECOMPENSA';
  btn.disabled=alreadyClaimed;btn.style.opacity=alreadyClaimed?.5:1;
}
function claimDaily(){
  const today=new Date().toDateString();
  if(G.lastLogin===today){showNotif('â° Â¡Vuelve maÃ±ana!');return;}
  G.lastLogin=today;G.streak=Math.min((G.streak||0)+1,7);
  const r=DAILY[(G.streak-1)%7];
  if(r.icon==='ğŸª™')G.coins+=parseInt(r.val.replace(/\./g,''))||300;
  if(r.icon==='ğŸ’')G.gems+=parseInt(r.val)||10;
  if(r.icon==='ğŸ‚')G.powerups.rodillo+=3;
  if(r.icon==='â¬†ï¸')G.powerups.levadura+=3;
  if(r.icon==='ğŸŒŸ'){G.gems+=150;G.coins+=5000;}
  saveG();sfxWin();updateCurrBar();
  showNotif(`ğŸ DÃ­a ${G.streak}: ${r.icon} ${r.val} recibido!`);goDaily();
}

// PANELS & SCREENS
function showPanel(id){const p=document.getElementById(id);p.classList.remove('hidden');requestAnimationFrame(()=>p.classList.add('show'));}
function hidePanel(id){const p=document.getElementById(id);p.classList.remove('show');setTimeout(()=>p.classList.add('hidden'),340);}
function hideAllPanels(){document.querySelectorAll('.panel-bg').forEach(p=>{p.classList.remove('show');p.classList.add('hidden');});}
function showScreen(id){document.getElementById(id)?.classList.remove('hidden');}
function hideAllScreens(){document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));}
function goMenu(){
  hideAllPanels();hideAllScreens();showScreen('menuScreen');updateCurrBar();
  const ch=CHAPTERS[Math.min(G.currentChapter-1,CHAPTERS.length-1)];
  const badge=document.getElementById('bakeryBadge');
  if(badge)badge.textContent=`${ch.icon} ${ch.bakeryName}`;
}
function updateCurrBar(){
  document.getElementById('mCoins').textContent=G.coins.toLocaleString();
  document.getElementById('mGems').textContent=G.gems;
}

// NOTIF & POPUPS
let notifTimer;
function showNotif(msg){
  const el=document.getElementById('notif');el.textContent=msg;el.classList.add('show');
  clearTimeout(notifTimer);notifTimer=setTimeout(()=>el.classList.remove('show'),2800);
}
function showMergePopup(x,y,ing,pts){
  const old=document.querySelector('.mpop');if(old)old.remove();
  const d=document.createElement('div');d.className='mpop';
  d.style.cssText=`left:${x}px;top:${y}px`;
  d.innerHTML=`<div class="mpop-em">${ing.e}</div><div class="mpop-nm">${ing.n.toUpperCase()}</div><div class="mpop-pt">+${pts.toLocaleString()}</div>${GM.combo>2?`<div class="mpop-combo">Â¡Combo Ã—${GM.combo}!</div>`:''}`;
  document.body.appendChild(d);setTimeout(()=>d.remove(),950);
}

// â”€â”€â”€ ANIMATED CANVAS BACKGROUND â”€â”€â”€
const bgC=document.getElementById('bgC'),bgX=bgC.getContext('2d');
const ptC=document.getElementById('ptC'),ptX=ptC.getContext('2d');
let W,H,particles=[],floaters=[],blobs=[],stars2=[];
let bgTime=0;

const BLOB_COLORS=[
  'rgba(236,72,153,',  // pink
  'rgba(168,85,247,',  // purple
  'rgba(251,191,36,',  // amber
  'rgba(59,130,246,',  // blue
  'rgba(52,211,153,',  // mint
  'rgba(244,63,94,',   // rose
];
const FLOAT_EMOJIS=['ğŸ¬','ğŸ‚','ğŸ§','ğŸ©','ğŸ°','ğŸŒ¸','â­','âœ¨','ğŸ­','ğŸ¥','ğŸ«','ğŸ’'];

function resize(){
  W=window.innerWidth;H=window.innerHeight;
  bgC.width=W;bgC.height=H;ptC.width=W;ptC.height=H;

  // Animated gradient blobs
  blobs=[];
  for(let i=0;i<6;i++){
    blobs.push({
      x:Math.random()*W,y:Math.random()*H,
      r:100+Math.random()*200,
      c:BLOB_COLORS[i%BLOB_COLORS.length],
      vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,
      phase:Math.random()*Math.PI*2,
      speed:0.005+Math.random()*0.012,
    });
  }

  // Tiny twinkling stars
  stars2=[];
  for(let i=0;i<80;i++){
    stars2.push({x:Math.random()*W,y:Math.random()*H,r:.5+Math.random()*1.5,phase:Math.random()*Math.PI*2,speed:0.02+Math.random()*0.04});
  }

  // Floating emoji elements
  floaters=[];
  for(let i=0;i<14;i++){
    floaters.push({
      x:Math.random()*W,y:Math.random()*H+H,
      emoji:FLOAT_EMOJIS[~~(Math.random()*FLOAT_EMOJIS.length)],
      size:14+Math.random()*20,
      vy:-(0.25+Math.random()*0.45),
      vx:(Math.random()-.5)*0.3,
      alpha:0.12+Math.random()*0.18,
      rot:Math.random()*Math.PI*2,
      rotSpeed:(Math.random()-.5)*0.015,
    });
  }
}

function drawBg(){
  bgTime+=0.008;

  // Deep dark base gradient â€” shifts between purple/indigo/dark-rose
  const hue1=280+Math.sin(bgTime*0.3)*20;
  const hue2=320+Math.cos(bgTime*0.25)*25;
  const grd=bgX.createLinearGradient(0,0,W,H);
  grd.addColorStop(0,`hsl(${hue1},60%,6%)`);
  grd.addColorStop(0.5,`hsl(${(hue1+hue2)/2},55%,8%)`);
  grd.addColorStop(1,`hsl(${hue2},58%,5%)`);
  bgX.fillStyle=grd;bgX.fillRect(0,0,W,H);

  // Animated glowing blobs
  blobs.forEach(b=>{
    b.phase+=b.speed;
    b.x+=b.vx+Math.sin(b.phase)*0.4;
    b.y+=b.vy+Math.cos(b.phase*0.7)*0.3;
    if(b.x<-b.r)b.x=W+b.r;if(b.x>W+b.r)b.x=-b.r;
    if(b.y<-b.r)b.y=H+b.r;if(b.y>H+b.r)b.y=-b.r;
    const pulse=0.08+0.06*Math.sin(b.phase*2);
    const g=bgX.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r*(1+Math.sin(b.phase)*0.15));
    g.addColorStop(0,b.c+(pulse+.05)+')');
    g.addColorStop(0.5,b.c+(pulse*0.4)+')');
    g.addColorStop(1,'rgba(0,0,0,0)');
    bgX.fillStyle=g;bgX.beginPath();bgX.arc(b.x,b.y,b.r*1.2,0,Math.PI*2);bgX.fill();
  });

  // Twinkling stars
  stars2.forEach(s=>{
    s.phase+=s.speed;
    const a=0.15+0.5*Math.abs(Math.sin(s.phase));
    bgX.beginPath();bgX.arc(s.x,s.y,s.r,0,Math.PI*2);
    bgX.fillStyle=`rgba(255,220,255,${a})`;bgX.fill();
  });

  // Thin shimmer line sweeping across
  const shimX=((bgTime*0.08)%1.4-.2)*W;
  const shimG=bgX.createLinearGradient(shimX-60,0,shimX+60,H);
  shimG.addColorStop(0,'rgba(255,180,255,0)');
  shimG.addColorStop(0.5,'rgba(255,180,255,0.025)');
  shimG.addColorStop(1,'rgba(255,180,255,0)');
  bgX.fillStyle=shimG;bgX.fillRect(0,0,W,H);

  // Floating emoji pastries
  bgX.save();
  floaters.forEach(f=>{
    f.y+=f.vy;f.x+=f.vx;f.rot+=f.rotSpeed;
    if(f.y<-60){f.y=H+30;f.x=Math.random()*W;}
    bgX.save();
    bgX.globalAlpha=f.alpha*(0.7+0.3*Math.sin(bgTime+f.rot));
    bgX.translate(f.x,f.y);bgX.rotate(f.rot);
    bgX.font=`${f.size}px serif`;
    bgX.textAlign='center';bgX.textBaseline='middle';
    bgX.fillText(f.emoji,0,0);
    bgX.restore();
  });
  bgX.restore();
}

// Particles
function spawnPt(x,y,color,count){
  for(let i=0;i<count;i++){
    const a=(Math.PI*2/count)*i+Math.random()*.5,sp=2+Math.random()*5;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:.025+Math.random()*.03,r:2+Math.random()*5,color,type:i%4===0?'ring':'dot'});
  }
  // Extra sparkle burst for big merges
  for(let i=0;i<4;i++){
    const a=Math.random()*Math.PI*2,sp=1+Math.random()*3;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,life:.8,decay:.04,r:1+Math.random()*3,color:'#fff',type:'dot'});
  }
}
function drawPt(){
  ptX.clearRect(0,0,W,H);
  particles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.07;p.vx*=.97;p.vy*=.97;p.life-=p.decay;
    if(p.life<=0)return;
    ptX.globalAlpha=p.life;
    if(p.type==='ring'){ptX.beginPath();ptX.arc(p.x,p.y,p.r*p.life+2,0,Math.PI*2);ptX.strokeStyle=p.color;ptX.lineWidth=1.5;ptX.stroke();}
    else{ptX.beginPath();ptX.arc(p.x,p.y,p.r,0,Math.PI*2);ptX.fillStyle=p.color;ptX.fill();}
    ptX.globalAlpha=1;
  });
  particles=particles.filter(p=>p.life>0);
}
let raf;function bgLoop(){raf=requestAnimationFrame(bgLoop);drawBg();drawPt();}

// AUDIO
let ac2;
function ac(){if(!ac2)ac2=new(window.AudioContext||window.webkitAudioContext)();return ac2;}
function tone(f,t,v=.12,type='sine'){try{const o=ac().createOscillator(),g=ac().createGain();o.connect(g);g.connect(ac().destination);o.type=type;o.frequency.value=f;g.gain.setValueAtTime(v,ac().currentTime);g.gain.exponentialRampToValueAtTime(.001,ac().currentTime+t);o.start();o.stop(ac().currentTime+t);}catch(e){}}
const sfxT=()=>tone(600,.08,.08,'sine');
const sfxMerge=(tier)=>{tone(350+tier*60,.18,.12,'sine');tone(500+tier*80,.12,.08,'triangle');};
const sfxBig=()=>{tone(880,.25,.15);setTimeout(()=>tone(1100,.2,.12),100);};
const sfxFail=()=>tone(180,.3,.1,'sawtooth');
const sfxWin=()=>{[523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>tone(f,.25,.1),i*90));};
const sfxCoin=()=>{tone(1400,.08,.07);setTimeout(()=>tone(1760,.08,.05),70);};
const sfxPu=()=>tone(700,.15,.1,'square');

// INIT
window.addEventListener('resize',()=>{resize();if(!document.getElementById('gameScreen')?.classList.contains('hidden'))renderGrid();});
loadG();resize();bgLoop();updateCurrBar();

document.getElementById('btnHornear').addEventListener('click',goChapters);
document.getElementById('btnTienda').addEventListener('click',goShop);
document.getElementById('btnLibro').addEventListener('click',goStats);
document.getElementById('btnDiario').addEventListener('click',goDaily);

const firstStory=ALL_STORIES[1];
if(G.unlocked===1&&!G.storiesSeen[1]&&firstStory){
  G.storiesSeen[1]=true;saveG();
  showStory(firstStory,()=>{hideAllScreens();showScreen('menuScreen');updateCurrBar();});
} else {
  showScreen('menuScreen');
}
if(G.lastLogin!==new Date().toDateString()&&G.unlocked>1)
  setTimeout(()=>showNotif('ğŸ Â¡Tu recompensa diaria te espera!'),1800);
</script>
</body>
</html>
