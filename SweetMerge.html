<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SWEET MERGE v2 â€” PastelerÃ­a MÃ¡gica Â· 600 Niveles</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Poppins:wght@300;400;500;600;700;800&family=Dancing+Script:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#1a0428;--bg2:#2d0844;
  --cream:#fdf6e3;--cream2:#fef9f0;
  --pink:#f472b6;--pink2:#ec4899;--pink3:#fce7f3;
  --rose:#fb7185;--rose2:#f43f5e;
  --amber:#fbbf24;--amber2:#f59e0b;--amber3:#fef3c7;
  --brown:#f9a8d4;--brown2:#f472b6;--brown3:#fce7f3;
  --mint:#34d399;--mint2:#10b981;
  --purple:#c084fc;--purple2:#a855f7;
  --blue:#60a5fa;--blue2:#3b82f6;
  --text:#fff0f8;--text2:rgba(255,240,248,.6);--text3:rgba(255,240,248,.3);
  --card:rgba(255,255,255,.07);--border:rgba(255,160,210,.15);--border2:rgba(255,160,210,.3);
  --shadow:rgba(200,0,120,.25);--rad:16px;
  --rival:#7f1d1d;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0428;font-family:'Poppins',sans-serif;color:var(--text);touch-action:none}
canvas{position:fixed;top:0;left:0;pointer-events:none!important;z-index:0}
#bgC{z-index:1;pointer-events:none!important}#ptC{z-index:2;pointer-events:none!important}
#app{position:fixed;inset:0;z-index:10;overflow:hidden}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s,transform .4s}
.screen.hidden{opacity:0;transform:scale(.97);pointer-events:none;display:none!important}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{border:none;border-radius:var(--rad);cursor:pointer;font-family:'Poppins',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase;transition:transform .12s,box-shadow .15s;touch-action:manipulation;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.93)}
.btn-prime{background:linear-gradient(135deg,#be185d,#ec4899,#be185d);color:#fff;font-size:14px;padding:16px 34px;border:1px solid rgba(236,72,153,.5);box-shadow:0 6px 24px rgba(236,72,153,.3),inset 0 1px 0 rgba(255,255,255,.2)}
.btn-gold{background:linear-gradient(135deg,#92400e,#f59e0b,#92400e);color:#fff;font-size:14px;padding:15px 32px;border:1px solid rgba(245,158,11,.4);box-shadow:0 6px 20px rgba(245,158,11,.25)}
.btn-red{background:linear-gradient(135deg,#7f1d1d,#dc2626);color:#fff;font-size:14px;padding:14px 28px;border-radius:14px}
.btn-ghost{background:rgba(255,255,255,.6);color:var(--text2);font-size:13px;padding:13px 26px;border:1px solid var(--border);backdrop-filter:blur(8px)}
.btn-sm{font-size:12px;padding:10px 20px;border-radius:12px}
.btn-rival{background:linear-gradient(135deg,#450a0a,#b91c1c,#450a0a);color:#fecaca;font-size:14px;padding:15px 32px;border:1px solid rgba(220,38,38,.5);box-shadow:0 0 25px rgba(220,38,38,.3);animation:rivalGlow 2s ease-in-out infinite}
@keyframes rivalGlow{0%,100%{box-shadow:0 0 20px rgba(220,38,38,.3)}50%{box-shadow:0 0 40px rgba(220,38,38,.6)}}

/* â”€â”€ FONTS â”€â”€ */
.pl{font-family:'Playfair Display',serif}
.ds{font-family:'Dancing Script',cursive}

/* â”€â”€ LOGO â”€â”€ */
.logo-pre{font-family:'Poppins',sans-serif;font-size:clamp(9px,2.2vw,12px);letter-spacing:6px;color:var(--pink2);opacity:.8;text-transform:uppercase;margin-bottom:6px}
.logo-main{font-family:'Playfair Display',serif;font-size:clamp(46px,12vw,82px);font-weight:900;line-height:.9;background:linear-gradient(135deg,#fff 0%,#fbbf24 30%,#f472b6 65%,#c084fc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 4px 20px rgba(236,72,153,.4));animation:logoShine 4s ease-in-out infinite}
@keyframes logoShine{0%,100%{filter:drop-shadow(0 4px 20px rgba(236,72,153,.4))}50%{filter:drop-shadow(0 4px 32px rgba(192,132,252,.6))}}
.logo-sub{font-family:'Dancing Script',cursive;font-size:clamp(16px,4vw,22px);color:var(--amber2);margin-top:4px;letter-spacing:1px}
.logo-tagline{font-family:'Poppins',sans-serif;font-style:italic;font-size:clamp(11px,2.8vw,13px);color:var(--text2);text-align:center;margin-top:14px;line-height:1.6;max-width:300px;padding:0 16px}

/* â”€â”€ CURRENCY â”€â”€ */
.curr-bar{position:absolute;top:14px;right:14px;display:flex;gap:7px;z-index:20}
.curr-pill{background:rgba(0,0,0,.45);border:1px solid var(--border2);border-radius:20px;padding:6px 13px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:5px;backdrop-filter:blur(14px);box-shadow:0 2px 14px var(--shadow);color:var(--text)}

/* â”€â”€ BACK BTN â”€â”€ */
.back{position:absolute;top:14px;left:14px;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:12px;padding:8px 15px;font-size:12px;color:var(--text2);cursor:pointer;font-family:'Poppins',sans-serif;font-weight:600;touch-action:manipulation;transition:all .15s;z-index:20;backdrop-filter:blur(12px)}
.back:active{transform:scale(.93)}

/* â”€â”€ MENU NAV â”€â”€ */
.menu-nav{display:flex;flex-direction:column;gap:10px;width:min(270px,82vw);margin-top:28px}

/* â”€â”€ CHAPTER SELECT â”€â”€ */
#chapterScreen{justify-content:flex-start;padding-top:70px;padding-bottom:20px;overflow-y:auto}
.chapter-cards{display:flex;flex-direction:column;gap:10px;width:min(400px,94vw);padding:0 12px}
.chap-card{border-radius:18px;padding:14px 17px;cursor:pointer;transition:all .2s;touch-action:manipulation;border:1px solid var(--border);display:flex;align-items:center;gap:13px;position:relative;overflow:hidden;backdrop-filter:blur(12px);box-shadow:0 4px 20px var(--shadow)}
.chap-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.05),transparent);pointer-events:none}
.chap-card:active{transform:scale(.97)}
.chap-card.locked{opacity:.45;cursor:default}
.chap-card.locked::after{content:'ğŸ”’';position:absolute;right:16px;font-size:20px}
.chap-icon{font-size:36px;flex-shrink:0}
.chap-info{flex:1;min-width:0}
.chap-num{font-family:'Poppins',sans-serif;font-size:10px;letter-spacing:3px;opacity:.55;text-transform:uppercase;margin-bottom:2px}
.chap-name{font-family:'Playfair Display',serif;font-size:clamp(13px,3.5vw,15px);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.chap-desc{font-size:11px;color:var(--text2);margin-top:2px}
.chap-prog{font-size:10px;color:var(--amber2);margin-top:3px;font-weight:600}

/* â”€â”€ LEVEL SELECT â”€â”€ */
#levelScreen{justify-content:flex-start;padding-top:68px;overflow-y:auto;padding-bottom:24px}
.lvl-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;width:min(370px,95vw);padding:0 10px}
.lvl-btn{aspect-ratio:1;border-radius:13px;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .18s;touch-action:manipulation;position:relative;overflow:hidden}
.lvl-btn:active{transform:scale(.9)}
.lvl-btn.locked{background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.07);cursor:default}
.lvl-btn.unlocked{background:linear-gradient(135deg,rgba(236,72,153,.12),rgba(245,158,11,.12));border:1px solid rgba(236,72,153,.25)}
.lvl-btn.completed{background:linear-gradient(135deg,rgba(52,211,153,.15),rgba(245,158,11,.12));border:1px solid rgba(52,211,153,.3)}
.lvl-btn.rival-lvl{background:linear-gradient(135deg,rgba(220,38,38,.2),rgba(124,45,18,.15))!important;border-color:rgba(220,38,38,.45)!important;box-shadow:0 0 10px rgba(220,38,38,.2)!important}
.lvl-btn.rival-lvl .lvl-n{color:#dc2626!important;font-weight:800}
.lvl-n{font-family:'Playfair Display',serif;font-size:12px;font-weight:700;color:var(--text)}
.lvl-ico{font-size:13px;line-height:1}
.lvl-stars{font-size:7px;letter-spacing:-1px;margin-top:1px}

/* â”€â”€ STORY â”€â”€ */
#storyScreen{background:linear-gradient(160deg,#1a0428,#2d0844,#1a0428)}
.story-wrap{display:flex;flex-direction:column;align-items:center;text-align:center;max-width:370px;animation:fadeUp .6s ease-out;padding:0 20px}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.st-episode{font-family:'Poppins',sans-serif;font-size:10px;letter-spacing:4px;color:var(--pink2);opacity:.8;text-transform:uppercase;margin-bottom:10px}
.st-icon{font-size:70px;margin-bottom:14px;animation:floatSt 3s ease-in-out infinite}
@keyframes floatSt{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.st-title{font-family:'Playfair Display',serif;font-size:clamp(18px,5vw,26px);font-weight:700;color:var(--amber2);margin-bottom:12px;line-height:1.2}
.st-divider{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--amber),transparent);margin:0 auto 16px;border-radius:2px}
.st-text{font-size:clamp(12px,3.2vw,14px);color:var(--text2);line-height:1.9;font-style:italic}
.st-quote{font-family:'Dancing Script',cursive;font-size:clamp(13px,3.5vw,16px);color:var(--pink2);margin-top:14px;letter-spacing:.5px}

/* â”€â”€ RIVAL INTRO â”€â”€ */
#rivalIntroScreen{background:linear-gradient(160deg,#1a0010,#2d0020,#1a0010)}
.rival-wrap{display:flex;flex-direction:column;align-items:center;text-align:center;max-width:350px;padding:0 18px}
.rival-pre{font-family:'Poppins',sans-serif;font-size:9px;letter-spacing:5px;color:#dc2626;text-transform:uppercase;margin-bottom:8px;animation:rpulse 1.5s ease-in-out infinite}
@keyframes rpulse{0%,100%{opacity:.6}50%{opacity:1}}
.rival-icon{font-size:78px;margin:6px 0;animation:rivalBob 2s ease-in-out infinite}
@keyframes rivalBob{0%,100%{transform:scale(1) rotate(-2deg)}50%{transform:scale(1.07) rotate(2deg)}}
.rival-name{font-family:'Playfair Display',serif;font-size:clamp(20px,6vw,32px);font-weight:900;color:#991b1b;margin-bottom:4px}
.rival-title-tag{font-size:11px;letter-spacing:3px;color:#dc2626;opacity:.75;text-transform:uppercase;margin-bottom:12px;font-weight:600}
.rival-lore{font-size:clamp(12px,3vw,13px);color:#7f1d1d;line-height:1.8;font-style:italic;margin-bottom:18px}
.rival-abilities{display:flex;flex-direction:column;gap:7px;width:100%;margin-bottom:20px}
.rival-ability{background:rgba(220,38,38,.07);border:1px solid rgba(220,38,38,.18);border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:10px;text-align:left}
.ra-icon{font-size:17px;flex-shrink:0}
.ra-text{font-size:12px;color:#991b1b;font-weight:600}
.ra-desc{font-size:11px;color:rgba(127,29,29,.6)}

/* â”€â”€ GAME HUD â”€â”€ */
#gameScreen{justify-content:flex-start;padding:0}
#gHud{width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 14px 6px;background:linear-gradient(180deg,rgba(26,4,40,.97) 0%,rgba(26,4,40,.5) 100%);flex-shrink:0;position:relative;z-index:5;border-bottom:1px solid var(--border)}
.hb{display:flex;flex-direction:column;align-items:center}
.hl{font-size:8px;letter-spacing:2px;color:var(--text2);text-transform:uppercase}
.hv{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--text);line-height:1}
.hv.score{color:var(--brown)}
.hv.moves-low{color:var(--rose2)!important;animation:movesLow .6s ease-in-out infinite}
@keyframes movesLow{0%,100%{opacity:1}50%{opacity:.4}}
.moves-ring{width:48px;height:48px;position:relative;flex-shrink:0}
.moves-ring svg{transform:rotate(-90deg)}
.mv-txt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--text)}

/* â”€â”€ RIVAL HP BAR â”€â”€ */
#rivalHpBar{width:100%;padding:5px 14px 5px;flex-shrink:0;display:none}
.rival-hp-wrap{background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.2);border-radius:12px;padding:7px 12px}
.rival-hp-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.rival-hp-name{font-family:'Playfair Display',serif;font-size:11px;color:#dc2626;letter-spacing:.5px}
.rival-hp-val{font-size:11px;color:#dc2626;font-weight:700}
.rival-hp-track{height:7px;background:rgba(220,38,38,.12);border-radius:4px;overflow:hidden}
.rival-hp-fill{height:100%;background:linear-gradient(90deg,#7f1d1d,#ef4444,#fca5a5);border-radius:4px;transition:width .4s;box-shadow:0 0 6px rgba(239,68,68,.4)}

/* â”€â”€ OBJECTIVE BANNER â”€â”€ */
#objBanner{width:100%;padding:5px 14px;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-bottom:1px solid var(--border)}
.obj-t{font-size:11px;color:var(--text2);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.obj-p{font-size:11px;font-weight:700;color:var(--pink2);flex-shrink:0;margin-left:8px}
.obj-prog-bar{width:55px;height:4px;background:rgba(0,0,0,.07);border-radius:2px;overflow:hidden;margin-left:8px;flex-shrink:0}
.obj-prog-fill{height:100%;background:linear-gradient(90deg,var(--pink2),var(--amber));border-radius:2px;transition:width .35s}

/* â”€â”€ GRID â”€â”€ */
#gridWrap{flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:5px;overflow:hidden}
#grid{display:grid;gap:5px;padding:10px;background:rgba(255,255,255,.04);border-radius:20px;border:1px solid rgba(255,160,210,.1);box-shadow:0 0 40px rgba(200,0,120,.15),inset 0 1px 0 rgba(255,255,255,.06)}
.tile{border-radius:13px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .1s,box-shadow .1s;position:relative;overflow:hidden;touch-action:manipulation;border:1.5px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.tile:active{transform:scale(.88)}
.tile.sel{transform:scale(1.07);z-index:5}
.tile-em{line-height:1}
.tile-nm{font-size:clamp(5px,1.2vw,7px);opacity:.65;margin-top:1px;text-align:center;font-weight:600;line-height:1;padding:0 2px;font-family:'Poppins',sans-serif}
.tile.frozen::after{content:'ğŸ¬';position:absolute;top:1px;right:2px;font-size:9px}
.tile.catalyst::before{content:'ğŸŒ¿';position:absolute;top:1px;left:2px;font-size:9px}
.tile.bombt::before{content:'ğŸ’£';position:absolute;top:1px;left:2px;font-size:9px}
.tile.shield::after{content:'ğŸ‚';position:absolute;top:1px;right:2px;font-size:9px}
.tile.cursed::after{content:'ğŸ”¥';position:absolute;top:1px;right:2px;font-size:9px}
.tile.mirror::before{content:'âœ¨';position:absolute;top:1px;left:2px;font-size:9px}
.tile-shine{position:absolute;top:-40%;left:-60%;width:25%;height:120%;background:linear-gradient(105deg,transparent,rgba(255,255,255,.35),transparent);transform:skewX(-25deg);animation:tshine 6s ease-in-out infinite}
@keyframes tshine{0%,80%,100%{left:-60%}90%{left:140%}}

/* â”€â”€ POWERUP BAR â”€â”€ */
#puBar{width:100%;display:flex;justify-content:center;gap:8px;padding:6px 14px 10px;flex-shrink:0}
.pu{width:52px;height:52px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.45);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;touch-action:manipulation;position:relative;backdrop-filter:blur(10px);box-shadow:0 2px 12px var(--shadow)}
.pu:active{transform:scale(.87)}
.pu.act{border-color:var(--pink2);box-shadow:0 0 14px rgba(236,72,153,.4)}
.pu-em{font-size:20px;line-height:1}
.pu-lb{font-size:7px;color:var(--text2);letter-spacing:.3px;margin-top:1px;font-weight:700;text-transform:uppercase}
.pu-ct{position:absolute;top:-5px;right:-5px;background:var(--pink2);color:#fff;font-size:9px;font-weight:700;border-radius:50%;width:17px;height:17px;display:flex;align-items:center;justify-content:center}

/* â”€â”€ RIVAL ATTACK FLASH â”€â”€ */
.rival-attack-overlay{position:fixed;inset:0;background:rgba(180,0,0,.25);pointer-events:none;z-index:60;opacity:0;animation:rivalFlash .5s ease-out forwards}
@keyframes rivalFlash{0%{opacity:1}100%{opacity:0}}

/* â”€â”€ PANELS â”€â”€ */
.panel-bg{position:fixed;inset:0;background:rgba(10,0,20,.88);backdrop-filter:blur(14px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
.panel-bg.show{opacity:1}
.panel-bg.hidden{display:none}
.panel{background:linear-gradient(155deg,#1e0535,#2d0a4e);border:1px solid var(--border2);border-radius:22px;padding:26px 22px;width:min(310px,90vw);text-align:center;box-shadow:0 20px 60px rgba(100,0,80,.5)}
.panel-icon{font-size:48px;margin-bottom:8px}
.panel h2{font-family:'Playfair Display',serif;font-size:clamp(17px,5vw,21px);margin-bottom:8px;color:var(--text)}
.panel p{font-size:13px;color:var(--text2);line-height:1.65;margin-bottom:18px}
.panel-btns{display:flex;flex-direction:column;gap:9px}
.res-stars{display:flex;justify-content:center;gap:8px;font-size:36px;margin:10px 0}
.res-score{font-family:'Playfair Display',serif;font-size:28px;color:var(--brown);font-weight:700}
.res-sub{font-size:11px;color:var(--text2);margin-bottom:5px;letter-spacing:1px}
.res-bonus{font-size:14px;color:var(--amber2);margin-bottom:16px;font-weight:700}
.rival-win-title{font-family:'Playfair Display',serif;font-size:clamp(18px,5vw,24px);color:var(--brown);margin-bottom:4px}
.rival-win-sub{font-size:11px;letter-spacing:3px;color:#dc2626;text-transform:uppercase;margin-bottom:16px;font-weight:600}

/* â”€â”€ SHOP â”€â”€ */
#shopScreen{justify-content:flex-start;padding-top:56px;padding-bottom:20px;overflow-y:auto}
.shop-hd{text-align:center;padding:0 16px 14px}
.shop-hd h1{font-family:'Playfair Display',serif;font-size:clamp(18px,5vw,24px);color:var(--brown)}
.shop-curr{font-size:12px;color:var(--text2);margin-top:3px}
.shop-sec{width:min(420px,96vw);padding:0 12px;margin-bottom:16px}
.shop-sec-title{font-family:'Poppins',sans-serif;font-size:10px;letter-spacing:3px;color:var(--pink2);opacity:.85;text-transform:uppercase;margin-bottom:9px;padding-left:3px;font-weight:700}
.shop-row{display:flex;gap:9px;overflow-x:auto;padding-bottom:3px}
.shop-row::-webkit-scrollbar{display:none}
.shop-card{flex-shrink:0;width:125px;background:rgba(255,255,255,.85);border:1px solid var(--border);border-radius:16px;padding:13px 10px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;transition:all .18s;touch-action:manipulation;position:relative;box-shadow:0 2px 10px var(--shadow)}
.shop-card:active{transform:scale(.94)}
.shop-card.feat{background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(236,72,153,.05));border-color:rgba(245,158,11,.35);box-shadow:0 4px 16px rgba(245,158,11,.15)}
.shop-card.pop::before{content:'ğŸ”¥ POPULAR';position:absolute;top:-9px;left:50%;transform:translateX(-50%);background:var(--rose2);color:#fff;font-size:7px;font-weight:700;padding:2px 9px;border-radius:9px;letter-spacing:.5px;white-space:nowrap}
.sc-icon{font-size:32px}
.sc-name{font-family:'Playfair Display',serif;font-size:10px;font-weight:700;color:var(--text);text-align:center}
.sc-desc{font-size:10px;color:var(--text2);text-align:center;line-height:1.3}
.sc-price{font-family:'Playfair Display',serif;font-size:12px;font-weight:700;color:var(--amber2)}

/* â”€â”€ STATS â”€â”€ */
.stat-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid rgba(255,240,248,.08)}
.stat-row:last-child{border:none}
.sl{font-size:13px;color:var(--text2)}
.sv{font-family:'Playfair Display',serif;font-size:13px;color:var(--text);font-weight:700}

/* â”€â”€ DAILY â”€â”€ */
.daily-grid{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin:14px 0}
.day-box{width:50px;height:62px;border-radius:11px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:1px solid var(--border);background:rgba(255,255,255,.05)}
.day-box.claimed{background:rgba(52,211,153,.1);border-color:rgba(52,211,153,.35)}
.day-box.today{background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(236,72,153,.1));border-color:var(--amber);box-shadow:0 0 12px rgba(245,158,11,.2)}
.day-box .dl{font-size:8px;color:var(--text2);letter-spacing:.8px;text-transform:uppercase;font-weight:600}
.day-box .di{font-size:18px}
.day-box .dv{font-size:9px;font-weight:700;color:var(--amber2)}

/* â”€â”€ NOTIFICATION â”€â”€ */
#notif{position:fixed;top:74px;left:50%;transform:translateX(-50%) translateY(-14px);background:rgba(30,5,50,.95);border:1px solid var(--border2);border-radius:13px;padding:9px 20px;font-size:12px;color:var(--tx,var(--text));z-index:400;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;backdrop-filter:blur(20px);box-shadow:0 6px 24px var(--shadow);font-weight:600}
#notif.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ MERGE POPUP â”€â”€ */
.mpop{position:fixed;pointer-events:none;z-index:300;text-align:center;transform:translate(-50%,-50%);animation:mpopAnim .85s ease-out forwards}
@keyframes mpopAnim{0%{opacity:1;transform:translate(-50%,-50%) scale(.6)}55%{opacity:1;transform:translate(-50%,-65%) scale(1.1)}100%{opacity:0;transform:translate(-50%,-82%) scale(.9)}}
.mpop-em{font-size:44px}
.mpop-nm{font-family:'Playfair Display',serif;font-size:14px;color:var(--brown);font-weight:700;letter-spacing:1px;margin-top:2px}
.mpop-pt{font-size:12px;color:var(--text2);font-weight:600}
.mpop-combo{font-family:'Dancing Script',cursive;font-size:15px;color:var(--pink2);margin-top:1px}

/* â”€â”€ MISC â”€â”€ */
.section-title{font-family:'Playfair Display',serif;font-size:clamp(16px,4vw,20px);margin-bottom:14px;color:var(--text)}
.version{position:absolute;bottom:16px;font-size:10px;color:var(--text3);letter-spacing:2px}

/* â”€â”€ BAKERY EVOLUTION BADGE â”€â”€ */
.bakery-badge{background:linear-gradient(135deg,rgba(236,72,153,.15),rgba(192,132,252,.1));border:1px solid var(--border2);border-radius:20px;padding:8px 18px;margin-top:12px;font-family:'Dancing Script',cursive;font-size:clamp(13px,3.5vw,16px);color:var(--amber2);text-align:center;box-shadow:0 4px 18px var(--shadow);backdrop-filter:blur(8px)}
</style>
</head>
<body>
<canvas id="bgC"></canvas>
<canvas id="ptC"></canvas>
<div id="app">

<!-- â•â•â•â• MAIN MENU â•â•â•â• -->
<div class="screen" id="menuScreen">
  <div class="curr-bar">
    <div class="curr-pill">ğŸ’°<span id="mCoins">0</span></div>
    <div class="curr-pill">ğŸ’<span id="mGems">0</span></div>
  </div>
  <div style="text-align:center">
    <div class="logo-pre">PASTELERÃA MÃGICA</div>
    <div class="logo-main">Sweet<br>Merge</div>
    <div class="logo-sub">La Historia del Gran Pastel</div>
    <div class="bakery-badge" id="bakeryBadge">ğŸ  PequeÃ±o Obrador Casero</div>
    <div class="logo-tagline">"Heredaste una cocina vieja y un cuaderno de recetas secretas. Con tus manos y tu pasiÃ³n, construirÃ¡s la pastelerÃ­a mÃ¡s famosa del mundo."</div>
  </div>
  <div class="menu-nav">
    <button class="btn btn-prime" id="btnHornear" onclick="goChapters()">ğŸ‚ HORNEAR AHORA</button>
    <button class="btn btn-gold" id="btnTienda" onclick="goShop()">ğŸ›’ TIENDA DE INGREDIENTES</button>
    <button class="btn btn-ghost" id="btnLibro" onclick="goStats()">ğŸ“œ LIBRO DE RECETAS</button>
    <button class="btn btn-ghost" id="btnDiario" onclick="goDaily()">ğŸ RECOMPENSA DIARIA</button>
  </div>
  <div class="version pl">v2.0 Â· 900 Niveles Â· 30 CapÃ­tulos Â· Sweet Merge</div>
</div>

<!-- â•â•â•â• STORY â•â•â•â• -->
<div class="screen hidden" id="storyScreen">
  <div class="story-wrap">
    <div class="st-episode" id="stEpisode">PRÃ“LOGO</div>
    <div class="st-icon" id="stIcon">ğŸ </div>
    <div class="st-title" id="stTitle">Un Nuevo Comienzo</div>
    <div class="st-divider"></div>
    <div class="st-text" id="stText">Texto de historia...</div>
    <div class="st-quote" id="stQuote"></div>
    <button class="btn btn-prime" style="margin-top:26px;width:min(230px,75vw)" onclick="dismissStory()">CONTINUAR â†’</button>
  </div>
</div>

<!-- â•â•â•â• RIVAL INTRO â•â•â•â• -->
<div class="screen hidden" id="rivalIntroScreen">
  <div class="rival-wrap">
    <div class="rival-pre">âš” RETO ESPECIAL</div>
    <div class="rival-icon" id="riIcon">ğŸ‘¨â€ğŸ³</div>
    <div class="rival-name" id="riName">RIVAL</div>
    <div class="rival-title-tag" id="riTitle">El Rival</div>
    <div class="rival-lore" id="riLore">Lore...</div>
    <div class="rival-abilities" id="riAbilities"></div>
    <button class="btn btn-rival" style="width:min(230px,75vw)" onclick="dismissRivalIntro()">ğŸ‘¨â€ğŸ³ Â¡ACEPTAR RETO!</button>
  </div>
</div>

<!-- â•â•â•â• CHAPTER SELECT â•â•â•â• -->
<div class="screen hidden" id="chapterScreen">
  <button class="back" onclick="goMenu()">â† MENÃš</button>
  <div style="font-family:'Playfair Display',serif;font-size:clamp(16px,4.5vw,22px);color:var(--brown);margin-bottom:16px;margin-top:54px">ğŸ—ºï¸ Mapa de la PastelerÃ­a</div>
  <div class="chapter-cards" id="chapterCards"></div>
</div>

<!-- â•â•â•â• LEVEL SELECT â•â•â•â• -->
<div class="screen hidden" id="levelScreen">
  <button class="back" onclick="goChapters()">â† CAPÃTULOS</button>
  <div style="font-family:'Playfair Display',serif;font-size:clamp(13px,4vw,18px);color:var(--text);margin-bottom:14px;margin-top:54px" id="levelScreenTitle">CAPÃTULO I</div>
  <div class="lvl-grid" id="lvlGrid"></div>
</div>

<!-- â•â•â•â• GAME â•â•â•â• -->
<div class="screen hidden" id="gameScreen">
  <div id="gHud">
    <div class="hb"><div class="hl">PUNTOS</div><div class="hv score" id="hScore">0</div></div>
    <div class="moves-ring">
      <svg width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="none" stroke="rgba(61,26,0,.08)" stroke-width="4"/><circle id="mvArc" cx="24" cy="24" r="20" fill="none" stroke="url(#mg)" stroke-width="4" stroke-linecap="round" stroke-dasharray="125.7" stroke-dashoffset="0"/><defs><linearGradient id="mg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ec4899"/><stop offset="100%" stop-color="#f59e0b"/></linearGradient></defs></svg>
      <div class="mv-txt" id="hMoves">30</div>
    </div>
    <div class="hb" style="align-items:flex-end"><div class="hl">NIVEL</div><div class="hv" id="hLevel">1</div></div>
  </div>
  <div id="rivalHpBar">
    <div class="rival-hp-wrap">
      <div class="rival-hp-top"><span class="rival-hp-name" id="rivalHpName">RIVAL</span><span class="rival-hp-val" id="rivalHpVal">100/100</span></div>
      <div class="rival-hp-track"><div class="rival-hp-fill" id="rivalHpFill" style="width:100%"></div></div>
    </div>
  </div>
  <div id="objBanner">
    <div class="obj-t" id="objTxt">Objetivo</div>
    <div class="obj-p" id="objPrg">0/0</div>
    <div class="obj-prog-bar"><div class="obj-prog-fill" id="objFill" style="width:0%"></div></div>
  </div>
  <div id="gridWrap"><div id="grid"></div></div>
  <div id="puBar">
    <div class="pu" id="puRodillo" onclick="selPu('rodillo')"><div class="pu-em">ğŸ‚</div><div class="pu-lb">DESTRUIR</div><div class="pu-ct" id="puRodilloN">0</div></div>
    <div class="pu" id="puBatidora" onclick="selPu('batidora')"><div class="pu-em">ğŸ”€</div><div class="pu-lb">MEZCLAR</div><div class="pu-ct" id="puBatidoraN">0</div></div>
    <div class="pu" id="puLevadura" onclick="selPu('levadura')"><div class="pu-em">â¬†ï¸</div><div class="pu-lb">SUBIR</div><div class="pu-ct" id="puLevaduraN">0</div></div>
    <div class="pu" id="puExtra" onclick="selPu('extra')"><div class="pu-em">â°</div><div class="pu-lb">+TIEMPO</div><div class="pu-ct" id="puExtraN">0</div></div>
  </div>
  <button class="back" style="top:12px;left:12px;padding:6px 11px;font-size:10px;z-index:20" onclick="confirmQuit()">âœ•</button>
</div>

<!-- â•â•â•â• SHOP â•â•â•â• -->
<div class="screen hidden" id="shopScreen">
  <button class="back" onclick="goMenu()">â† MENÃš</button>
  <div class="shop-hd" style="margin-top:46px">
    <h1>ğŸ›’ Tienda de Ingredientes</h1>
    <div class="shop-curr">ğŸ’° <span id="sCoins">0</span> &nbsp;|&nbsp; ğŸ’ <span id="sGems">0</span></div>
  </div>
  <div id="shopContent" style="width:min(420px,96vw)"></div>
</div>

<!-- â•â•â•â• STATS â•â•â•â• -->
<div class="screen hidden" id="statsScreen">
  <button class="back" onclick="goMenu()">â† MENÃš</button>
  <div class="section-title" style="margin-top:54px">ğŸ“œ Libro de Recetas</div>
  <div style="width:min(300px,90vw)" id="statRows"></div>
</div>

<!-- â•â•â•â• DAILY â•â•â•â• -->
<div class="screen hidden" id="dailyScreen">
  <button class="back" onclick="goMenu()">â† MENÃš</button>
  <div class="section-title" style="color:var(--amber2);margin-top:54px">ğŸ Entrega del DÃ­a</div>
  <div style="font-size:13px;color:var(--text2);margin-bottom:6px;text-align:center">Â¡Abre tu pastelerÃ­a cada dÃ­a!</div>
  <div class="daily-grid" id="dailyGrid"></div>
  <button class="btn btn-gold" style="width:min(230px,75vw);margin-top:10px" id="claimBtn" onclick="claimDaily()">ğŸ‚ RECOGER HOY</button>
</div>

</div><!-- /app -->

<!-- â•â•â•â• PANELS â•â•â•â• -->
<div class="panel-bg hidden" id="winPanel">
  <div class="panel">
    <div class="panel-icon">ğŸ†</div>
    <h2>Â¡Receta Completada!</h2>
    <div class="res-stars" id="resStars"></div>
    <div class="res-score" id="resScore"></div>
    <div class="res-sub" id="resBest"></div>
    <div class="res-bonus" id="resBonus"></div>
    <div class="panel-btns">
      <button class="btn btn-prime" onclick="nextLvl()">â–¶ SIGUIENTE RECETA</button>
      <button class="btn btn-ghost btn-sm" onclick="replayLvl()">ğŸ”„ REPETIR</button>
      <button class="btn btn-ghost btn-sm" onclick="goChapters()">ğŸ—ºï¸ MAPA</button>
    </div>
  </div>
</div>

<div class="panel-bg hidden" id="rivalWinPanel">
  <div class="panel" style="border-color:rgba(245,158,11,.35);box-shadow:0 20px 50px rgba(245,158,11,.15)">
    <div class="panel-icon">ğŸ¥‡</div>
    <div class="rival-win-title" id="rwTitle">Â¡Reto Superado!</div>
    <div class="rival-win-sub" id="rwSub">RIVAL DERROTADO</div>
    <div class="res-stars" id="rwStars"></div>
    <div class="res-score" id="rwScore"></div>
    <div class="res-bonus" id="rwBonus"></div>
    <div id="rwLore" style="font-size:12px;color:var(--text2);font-style:italic;margin-bottom:16px;line-height:1.65"></div>
    <div class="panel-btns">
      <button class="btn btn-prime" onclick="nextLvl()">â–¶ CONTINUAR</button>
      <button class="btn btn-ghost btn-sm" onclick="goChapters()">ğŸ—ºï¸ MAPA</button>
    </div>
  </div>
</div>

<div class="panel-bg hidden" id="losePanel">
  <div class="panel">
    <div class="panel-icon">ğŸ˜“</div>
    <h2 style="color:var(--rose2)">Â¡Se AcabÃ³ el Tiempo!</h2>
    <p>El horno se apagÃ³ antes de tiempo.<br>PuntuaciÃ³n: <strong id="goScore" style="color:var(--brown)">0</strong></p>
    <div class="panel-btns">
      <button class="btn btn-gold" onclick="buyMoves()">â° +5 Turnos â€” ğŸ’20</button>
      <button class="btn btn-ghost btn-sm" onclick="watchAd()">ğŸ“º Ver Anuncio â€” GRATIS</button>
      <button class="btn btn-ghost btn-sm" onclick="replayLvl()">ğŸ”„ Reintentar</button>
      <button class="btn btn-ghost btn-sm" onclick="goChapters()">ğŸ—ºï¸ Mapa</button>
    </div>
  </div>
</div>

<div class="panel-bg hidden" id="quitPanel">
  <div class="panel">
    <div class="panel-icon">ğŸ¤”</div>
    <h2>Â¿Cerrar el Horno?</h2>
    <p>El progreso del nivel actual se perderÃ¡.</p>
    <div class="panel-btns">
      <button class="btn btn-red" onclick="doQuit()">âœ• SALIR</button>
      <button class="btn btn-ghost btn-sm" onclick="hidePanel('quitPanel')">â† SEGUIR HORNEANDO</button>
    </div>
  </div>
</div>

<div id="notif"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWEET MERGE â€” PASTELERÃA MÃGICA Â· ENGINE v1.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ 30 INGREDIENT TIERS â”€â”€â”€
const ING=[
  {id:0,  e:'ğŸŒ¾',n:'Harina',       c:'#d4a96a',g:'rgba(212,169,106,.55)', p:10},
  {id:1,  e:'ğŸ¬',n:'AzÃºcar',       c:'#f9a8d4',g:'rgba(249,168,212,.55)', p:22},
  {id:2,  e:'ğŸ§ˆ',n:'Mantequilla',  c:'#fbbf24',g:'rgba(251,191,36,.6)',   p:50},
  {id:3,  e:'ğŸ¥š',n:'Huevo',        c:'#fef08a',g:'rgba(254,240,138,.6)',  p:100},
  {id:4,  e:'ğŸ¥›',n:'Leche',        c:'#e0f2fe',g:'rgba(224,242,254,.6)',  p:200},
  {id:5,  e:'ğŸ¯',n:'Miel',         c:'#f59e0b',g:'rgba(245,158,11,.6)',   p:380},
  {id:6,  e:'ğŸ«',n:'Cacao',        c:'#92400e',g:'rgba(146,64,14,.6)',    p:720},
  {id:7,  e:'ğŸ«',n:'ArÃ¡ndano',     c:'#6d28d9',g:'rgba(109,40,217,.5)',   p:1400},
  {id:8,  e:'ğŸ‹',n:'LimÃ³n',        c:'#fde68a',g:'rgba(253,230,138,.65)', p:2500},
  {id:9,  e:'ğŸŒ¸',n:'Vainilla',     c:'#fce7f3',g:'rgba(252,231,243,.7)',  p:4500},
  {id:10, e:'ğŸ¥',n:'Croissant',    c:'#d97706',g:'rgba(217,119,6,.65)',   p:8000},
  {id:11, e:'ğŸ§',n:'Magdalena',    c:'#f472b6',g:'rgba(244,114,182,.6)',  p:14000},
  {id:12, e:'ğŸ©',n:'Donut',        c:'#fb7185',g:'rgba(251,113,133,.6)',  p:24000},
  {id:13, e:'ğŸ¥§',n:'Tarta RÃºstica',c:'#a3a3a3',g:'rgba(163,163,163,.55)',p:40000},
  {id:14, e:'ğŸ°',n:'Pastel',       c:'#f43f5e',g:'rgba(244,63,94,.6)',    p:65000},
  {id:15, e:'ğŸ‚',n:'Tarta',        c:'#ec4899',g:'rgba(236,72,153,.65)',  p:100000},
  {id:16, e:'ğŸ®',n:'Flan Gourmet', c:'#fbbf24',g:'rgba(251,191,36,.65)', p:160000},
  {id:17, e:'ğŸª',n:'Galleta Art.', c:'#b45309',g:'rgba(180,83,9,.6)',     p:250000},
  {id:18, e:'ğŸ§‡',n:'Gofre Esp.',   c:'#f59e0b',g:'rgba(245,158,11,.65)', p:390000},
  {id:19, e:'ğŸ­',n:'Piruleta Art.',c:'#a855f7',g:'rgba(168,85,247,.65)', p:600000},
  {id:20, e:'ğŸ«',n:'Trufa de Lujo',c:'#7c2d12',g:'rgba(124,45,18,.65)',  p:900000},
  {id:21, e:'ğŸ¥®',n:'Pastel Luna',  c:'#f97316',g:'rgba(249,115,22,.65)', p:1400000},
  {id:22, e:'ğŸ',n:'Caja Bombones',c:'#ef4444',g:'rgba(239,68,68,.65)',  p:2200000},
  {id:23, e:'ğŸ¡',n:'Mochi Imperial',c:'#d946ef',g:'rgba(217,70,239,.65)',p:3500000},
  {id:24, e:'ğŸ’',n:'Tarta Nupcial',c:'#f1f5f9',g:'rgba(241,245,249,.8)', p:5500000},
  {id:25, e:'ğŸ‘‘',n:'Pastel Real',  c:'#f4c542',g:'rgba(244,197,66,.8)',  p:8500000},
  {id:26, e:'ğŸŒŸ',n:'Macaron Leg.', c:'#fde68a',g:'rgba(253,230,138,.85)',p:13000000},
  {id:27, e:'âœ¨',n:'Tarta Celeste',c:'#bfdbfe',g:'rgba(191,219,254,.85)',p:20000000},
  {id:28, e:'ğŸ†',n:'Obra Maestra', c:'#fbbf24',g:'rgba(251,191,36,.9)',  p:32000000},
  {id:29, e:'ğŸŒˆ',n:'PASTEL âˆ',     c:'#ffffff',g:'rgba(255,255,255,.95)',p:55000000},
];

// â”€â”€â”€ 30 CHAPTERS (bakery evolution) â”€â”€â”€
const CHAPTERS=[
  {id:1,name:'El PequeÃ±o Obrador',icon:'ğŸ ',color:'rgba(245,158,11,.18)',levels:[1,30],rivalLevel:30,
   desc:'Todo empezÃ³ en una cocina heredada de tu abuela RosalÃ­a.',
   bakeryName:'PequeÃ±o Obrador Casero',
   story:[
     {at:1,ep:'CAP 1',icon:'ğŸ ',title:'La Herencia Secreta',text:'Tu abuela RosalÃ­a era famosa en todo el barrio por sus pasteles imposibles. Cuando falleciÃ³, te dejÃ³ dos cosas: una cocina de madera con el horno mÃ¡s caprichoso del mundo, y un cuaderno de recetas escrito en una tinta que cambia de color segÃºn el Ã¡nimo del cocinero. Hoy es tu primer dÃ­a. El horno estÃ¡ frÃ­o. Pero en tu interior algo ya arde.',quote:'Las mejores recetas no se leen. Se sienten. â€” Abuela RosalÃ­a'},
     {at:16,ep:'CAP 1Â·II',icon:'ğŸ ',title:'El Inspector Llega',text:'El Inspector Grunwald lleva 25 aÃ±os cerrando obradores que no alcanzan sus estÃ¡ndares. Ha oÃ­do hablar de tu pequeÃ±o negocio. Necesitas que tus creaciones hablen por ti.',quote:'Un pastel mediocre es una mentira comestible. â€” Inspector Grunwald'},
   ]},
  {id:2,name:'Tienda de Barrio',icon:'ğŸª',color:'rgba(236,72,153,.16)',levels:[31,60],rivalLevel:60,
   desc:'Tu fama crece. Es hora de abrir una tienda de verdad en el vecindario.',
   bakeryName:'Dulce Barrio Â· Tienda Artesana',
   story:[
     {at:31,ep:'CAP 2',icon:'ğŸª',title:'El Gran Salto',text:'Con los ahorros de tres meses y un prÃ©stamo de DoÃ±a Carmen, alquilas el local frente a la farmacia. La primera maÃ±ana, siete clientes esperan antes de que abras. Tu corazÃ³n late tan rÃ¡pido como el batidor.',quote:'Siete clientes el primer dÃ­a. TÃº sÃ­ que tienes madera. â€” DoÃ±a Carmen'},
     {at:46,ep:'CAP 2Â·II',icon:'ğŸª',title:'El Rival del Barrio',text:'Al otro lado de la calle, la PastelerÃ­a Rivalino lleva treinta aÃ±os dominando el vecindario. Su hijo joven empieza a copiar tus precios. La guerra dulce ha comenzado.',quote:'Las imitaciones son el mejor halago... y la peor amenaza. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:3,name:'CafÃ© & PastelerÃ­a',icon:'â˜•',color:'rgba(146,64,14,.18)',levels:[61,90],rivalLevel:90,
   desc:'AÃ±ades cafÃ© y mesas. La gente ya no solo compra: se queda horas.',
   bakeryName:'CafÃ© RosalÃ­a Â· PastelerÃ­a y Tertulias',
   story:[
     {at:61,ep:'CAP 3',icon:'â˜•',title:'La Mesa MÃ¡gica',text:'Una tarde lluviosa pones dos mesas y una cafetera italiana. Lo que empezÃ³ como improvisaciÃ³n se convierte en el rincÃ³n favorito del barrio. Un pastel compartido sobre una mesa tiene poderes que no estÃ¡n en ningÃºn recetario.',quote:'La diferencia entre un postre y un recuerdo es el tiempo que tardas en comerlo. â€” TÃº'},
     {at:76,ep:'CAP 3Â·II',icon:'â˜•',title:'La CrÃ­tica MÃ¡s Temida',text:'Valentina Dura, la crÃ­tica gastronÃ³mica mÃ¡s temida de la regiÃ³n, entra sin avisar. Prueba tres pasteles con cara inexpresiva y se marcha sin decir nada. Esa noche no puedes dormir.',quote:'El silencio de una buena crÃ­tica vale mÃ¡s que mil palabras de una mala. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:4,name:'PastelerÃ­a MediterrÃ¡nea',icon:'ğŸŒŠ',color:'rgba(59,130,246,.16)',levels:[91,120],rivalLevel:120,
   desc:'La inspiraciÃ³n del MediterrÃ¡neo llega a tus recetas. Viajes que cambian el sabor.',
   bakeryName:'Mar Dulce Â· PastelerÃ­a MediterrÃ¡nea',
   story:[
     {at:91,ep:'CAP 4',icon:'ğŸŒŠ',title:'El Viaje de los Sabores',text:'Descubres el flan de algarroba de una abuelita griega, las palmeras de aceite de un obrador catalÃ¡n, el limÃ³n de Amalfi que hace llorar de felicidad. Regresas con quince recetas nuevas y arena en los zapatos.',quote:'Viajar con el estÃ³mago abierto es la mejor universidad. â€” Tu diario de viaje'},
     {at:106,ep:'CAP 4Â·II',icon:'ğŸŒŠ',title:'La Baronesa del Flan',text:'Madame CroÃ»ton dice pÃºblicamente que fusionar culturas en reposterÃ­a es un crimen gastronÃ³mico. Sus palabras llegan a la prensa. Necesitas responderle con algo mejor que palabras.',quote:'La mejor respuesta a las crÃ­ticas es un pastel tan bueno que te deje sin palabras. â€” TÃº'},
   ]},
  {id:5,name:'Laboratorio de Sabores',icon:'ğŸ”¬',color:'rgba(168,85,247,.16)',levels:[121,150],rivalLevel:150,
   desc:'La ciencia al servicio del dulce. TÃ©cnicas imposibles hechas realidad.',
   bakeryName:'Lab Dulce Â· GastronomÃ­a Molecular',
   story:[
     {at:121,ep:'CAP 5',icon:'ğŸ”¬',title:'La Ciencia del AzÃºcar',text:'Un curso de gastronomÃ­a molecular cambia todo. Descubres que el azÃºcar tiene memorias, que la mantequilla sueÃ±a, que un soufflÃ© es pura fÃ­sica cuÃ¡ntica. El cuaderno brilla mÃ¡s fuerte cada vez que aprendes algo nuevo.',quote:'La ciencia no destruye la magia. Solo le pone nombre. â€” Profesor GonzÃ¡lez'},
     {at:136,ep:'CAP 5Â·II',icon:'ğŸ”¬',title:'El Rey del Fast Cake',text:'Una cadena industrial anuncia cinco locales en tu ciudad. Sus pasteles duran seis meses. Tienen el mismo sabor que el embalaje. Pero son baratos. Â¿Puede lo artesanal sobrevivir?',quote:'Lo que se hace deprisa se olvida deprisa. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:6,name:'ConfiterÃ­a de Lujo',icon:'ğŸ’',color:'rgba(245,158,11,.18)',levels:[151,180],rivalLevel:180,
   desc:'La Ã©lite descubre tu pastelerÃ­a. Entra en el mundo del lujo artesano.',
   bakeryName:'Maison RosalÃ­a Â· Haute PÃ¢tisserie',
   story:[
     {at:151,ep:'CAP 6',icon:'ğŸ’',title:'El Encargo Imposible',text:'Una famosa actriz llega en limusina y pide un pastel para la gala mÃ¡s importante del paÃ­s. Presupuesto ilimitado. Fecha: cuatro dÃ­as. El cuaderno se abre solo en una pÃ¡gina antes en blanco.',quote:'Cuando el universo te manda un encargo, el cuaderno siempre tiene la respuesta. â€” TÃº'},
     {at:166,ep:'CAP 6Â·II',icon:'ğŸ’',title:'La Bruja del AzÃºcar',text:'La Bruja del AzÃºcar dominaba todos los encargos de Ã©lite de la ciudad. Ha empezado a sabotear tus entregas y sobornar a tus proveedores. Sus mÃ©todos van mÃ¡s allÃ¡ de los ingredientes.',quote:'El poder del azÃºcar no es endulzar. Es crear dependencia. â€” La Bruja del AzÃºcar'},
   ]},
  {id:7,name:'Escuela de ReposterÃ­a',icon:'ğŸ“',color:'rgba(52,211,153,.14)',levels:[181,210],rivalLevel:210,
   desc:'Abres tu propia escuela. El conocimiento de RosalÃ­a debe sobrevivir.',
   bakeryName:'Escuela RosalÃ­a Â· El Arte de lo Dulce',
   story:[
     {at:181,ep:'CAP 7',icon:'ğŸ“',title:'Los Primeros Alumnos',text:'Aceptas diez alumnos. Cada uno llega con sueÃ±os distintos. EnseÃ±ar te enseÃ±a mÃ¡s de lo que aprendiste solo. El cuaderno de RosalÃ­a se convierte en el libro de texto oficial.',quote:'El mejor ingrediente que puedes pasar a un alumno no estÃ¡ en la receta. â€” TÃº'},
     {at:196,ep:'CAP 7Â·II',icon:'ğŸ“',title:'El Gran Maestro',text:'El Gran Maestro Confitero llega sin avisar para evaluar tu metodologÃ­a. Si la aprueba, obtendrÃ¡s el certificado oficial. Su examen: recrear la receta perdida del Grand Ã‰clair de 1902.',quote:'La tradiciÃ³n sin innovaciÃ³n es un museo. La innovaciÃ³n sin tradiciÃ³n es un accidente. â€” Gran Maestro'},
   ]},
  {id:8,name:'Boutique Gourmet',icon:'ğŸ›ï¸',color:'rgba(217,70,239,.14)',levels:[211,240],rivalLevel:240,
   desc:'Tu marca se convierte en referente internacional. El mundo te llama.',
   bakeryName:'Boutique RosalÃ­a Â· ConfiterÃ­a Global',
   story:[
     {at:211,ep:'CAP 8',icon:'ğŸ›ï¸',title:'El Mundo Llama',text:'Una tienda en Tokio quiere importar tus macarons. Un hotel de Dubai pide exclusividad para tus tartas. Una cafeterÃ­a de Nueva York menciona tu nombre. El cuaderno tiene pÃ¡ginas en idiomas que no reconoces... pero entiendes.',quote:'La pastelerÃ­a es el Ãºnico idioma universal que existe. â€” Revista Bon PÃ¢tissier'},
     {at:226,ep:'CAP 8Â·II',icon:'ğŸ›ï¸',title:'El Gran Concurso',text:'Eres invitada al Gran Concurso Internacional. Ciento veinte participantes. La jueza lleva veinte aÃ±os sin conceder el primer premio. El cuaderno estÃ¡ en blanco. CrearÃ¡s desde cero.',quote:'El premio mÃ¡s grande no es el trofeo. Es saber que lo diste todo. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:9,name:'Palacio Dulce',icon:'ğŸ°',color:'rgba(251,191,36,.18)',levels:[241,270],rivalLevel:270,
   desc:'Tu pastelerÃ­a se convierte en una instituciÃ³n legendaria de fama mundial.',
   bakeryName:'Palacio RosalÃ­a Â· InstituciÃ³n Mundial',
   story:[
     {at:241,ep:'CAP 9',icon:'ğŸ°',title:'La InstituciÃ³n',text:'Ya no eres solo una pastelera. Eres una instituciÃ³n. Los presidentes piden tus postres en las cenas de estado. El cuaderno tiene pÃ¡ginas que escribes tÃº, y la tinta cambia de color segÃºn lo que sientes.',quote:'Construiste algo que outlasted al tiempo. Eso no lo enseÃ±a ningÃºn libro. â€” DoÃ±a Carmen'},
     {at:256,ep:'CAP 9Â·II',icon:'ğŸ°',title:'El BarÃ³n del Chocolate',text:'El BarÃ³n del Chocolate ha comprado las acciones de todos tus proveedores de cacao. Sus condiciones son inaceptables. La Ãºnica soluciÃ³n: crear un chocolate propio desde las plantas hasta la tableta.',quote:'El que controla los ingredientes controla los sueÃ±os ajenos. â€” El BarÃ³n'},
   ]},
  {id:10,name:'La Leyenda del AzÃºcar',icon:'ğŸŒˆ',color:'rgba(236,72,153,.18)',levels:[271,300],rivalLevel:300,
   desc:'El capÃ­tulo final del primer arco. La receta que lo cambia todo.',
   bakeryName:'ROSALÃA Â· La Leyenda',
   story:[
     {at:271,ep:'CAP 10',icon:'ğŸŒˆ',title:'El Ãšltimo Secreto',text:'El cuaderno revela su Ãºltimo secreto: una receta que nunca se completÃ³. La Tarta del Tiempo. Dicen que quien la hornea comprende por quÃ© los mejores momentos saben a azÃºcar y los difÃ­ciles a sal.',quote:'Toda mi vida fue prepararte para esta receta. â€” Ãšltima carta de Abuela RosalÃ­a'},
     {at:286,ep:'CAP 10Â·II',icon:'ğŸŒˆ',title:'El Gran Chef',text:'El Gran Chef llega con el reto final: Un pastel puede ser tÃ©cnicamente perfecto y no significar nada. Esta es la pregunta que llevabas diez capÃ­tulos respondiendo sin saberlo.',quote:'La tÃ©cnica se aprende. El alma no se enseÃ±a. â€” El Gran Chef'},
   ]},
  {id:11,name:'El Imperio del Macaron',icon:'ğŸŒ¸',color:'rgba(244,114,182,.16)',levels:[301,330],rivalLevel:330,
   desc:'El macaron conquista el mundo. Tu historia continÃºa en ParÃ­s.',
   bakeryName:'Atelier du Macaron Â· Paris',
   story:[
     {at:301,ep:'CAP 11',icon:'ğŸŒ¸',title:'ParÃ­s te Llama',text:'Una carta con el sello del Ministerio de Cultura FrancÃ©s. Te invitan a abrir un atelier en ParÃ­s durante seis meses. La ciudad del amor y la harina. Tu primera noche en la Ciudad de la Luz, sueÃ±as con el cuaderno escribiÃ©ndose solo.',quote:'Paris es la Ãºnica ciudad donde puedes llorar en la calle y parecer artÃ­stico. â€” TÃº, primer dÃ­a'},
     {at:316,ep:'CAP 11Â·II',icon:'ğŸŒ¸',title:'La Reina de los Macarons',text:'Colette Merveille lleva cincuenta aÃ±os siendo la maestra indiscutible del macaron parisino. Tiene un ojo que detecta imperfecciones a seis metros. El otro lo usa para despreciar a los competidores.',quote:'Un macaron imperfecto es una mentira bonita. No me interesan las mentiras. â€” Colette'},
   ]},
  {id:12,name:'El Chocolate de BÃ©lgica',icon:'ğŸ«',color:'rgba(146,64,14,.20)',levels:[331,360],rivalLevel:360,
   desc:'El mundo del chocolate fino belga. El origen de todos los sabores oscuros.',
   bakeryName:'Chocolaterie RosalÃ­a Â· Brujas',
   story:[
     {at:331,ep:'CAP 12',icon:'ğŸ«',title:'La Ciudad del Chocolate',text:'Brujas en invierno huele a canal, adoquines mojados y chocolate caliente. El maestro Jacques llora la primera vez que prueba tu ganache. Hay 47 tipos de cacao y cada uno tiene un carÃ¡cter tan distinto como una persona.',quote:'El chocolate tiene alma. Solo los cocineros con alma pueden escucharla. â€” Jacques'},
     {at:346,ep:'CAP 12Â·II',icon:'ğŸ«',title:'El Duelo de Trufas',text:'El Gremio de Chocolateros Belgas te desafÃ­a a un duelo de trufas. El perdedor debe abandonar Brujas. El cuaderno tiene una receta de trufa con un ingrediente imposible: memoria de primer beso.',quote:'Los mejores chocolates no se hacen con las manos. Se hacen con los recuerdos. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:13,name:'La PastelerÃ­a Japonesa',icon:'ğŸŒ',color:'rgba(239,68,68,.14)',levels:[361,390],rivalLevel:390,
   desc:'El arte del wagashi y la filosofÃ­a zen del dulce japonÃ©s te transforman.',
   bakeryName:'Wagashi RosalÃ­a Â· Tokio',
   story:[
     {at:361,ep:'CAP 13',icon:'ğŸŒ',title:'La FilosofÃ­a del Mochi',text:'Tokio: docenas de pastelerÃ­as en cada bloque con una filosofÃ­a que no habÃ­as encontrado. En JapÃ³n, un dulce no solo sabe. Comunica. El maestro Takahashi pasa tres dÃ­as enseÃ±Ã¡ndote que la forma del wagashi es tan importante como su sabor.',quote:'En el wagashi, la forma es el sabor. â€” Maestro Takahashi'},
     {at:376,ep:'CAP 13Â·II',icon:'ğŸŒ',title:'El Concurso Sakura',text:'El Concurso Sakura se celebra solo cuando florecen los cerezos. Eres la primera extranjera invitada en cuarenta aÃ±os. Solo puede ganar quien entienda el mono no aware: la melancolÃ­a de las cosas hermosas que terminan.',quote:'Lo mÃ¡s bello siempre tiene fecha de caducidad. Por eso es tan bello. â€” Haiku de RosalÃ­a'},
   ]},
  {id:14,name:'ReposterÃ­a Ãrabe',icon:'ğŸ•Œ',color:'rgba(251,191,36,.20)',levels:[391,420],rivalLevel:420,
   desc:'El mundo de la miel, el pistachero y la pasta filo en Marrakech.',
   bakeryName:'Al-RosalÃ­a Â· Halwa y Delicias',
   story:[
     {at:391,ep:'CAP 14',icon:'ğŸ•Œ',title:'El Mercado de las Especias',text:'Marrakech es un laberinto de sabores. Agua de rosas, azahar, cardamomo, azafrÃ¡n del precio del oro. El baklava de un puesto callejero hace que olvides todo lo que creÃ­as saber sobre el dulce.',quote:'En el desierto, el dulce mÃ¡s pequeÃ±o sabe a paraÃ­so. â€” Frase del zoco'},
     {at:406,ep:'CAP 14Â·II',icon:'ğŸ•Œ',title:'La Sultana del Baklava',text:'Fatima Al-Rashid lleva cuatro generaciones preparando baklava para la realeza. Su secreto familiar estÃ¡ protegido por juramentos del siglo XIV. Cuando prueba el tuyo, se queda en silencio un momento que parece durar siglos.',quote:'Algunas recetas viajan a travÃ©s del tiempo sin que nadie las transporte. â€” Fatima'},
   ]},
  {id:15,name:'El Circo del AzÃºcar',icon:'ğŸª',color:'rgba(168,85,247,.18)',levels:[421,450],rivalLevel:450,
   desc:'La pastelerÃ­a se convierte en espectÃ¡culo. Arte comestible en directo.',
   bakeryName:'Circo Dulce RosalÃ­a Â· Itinerante',
   story:[
     {at:421,ep:'CAP 15',icon:'ğŸª',title:'El Gran EspectÃ¡culo',text:'Una propuesta loca: crear pasteles en directo ante el pÃºblico. Sin red de seguridad. Sin segunda oportunidad. El horno mÃ¡s grande del mundo, en el escenario mÃ¡s grande que hayas visto.',quote:'En el circo, si el acrÃ³bata duda, cae. En la pastelerÃ­a, si el cocinero duda, el soufflÃ© cae. â€” Productor ValentÃ­n'},
     {at:436,ep:'CAP 15Â·II',icon:'ğŸª',title:'El Mago del Fondant',text:'Gustavo El MagnÃ­fico te desafÃ­a a un duelo de arte comestible en directo con un millÃ³n de espectadores. Sus veinte aÃ±os de experiencia frente a tu alma.',quote:'El fondant es arcilla del dios de los pasteles. En sus manos, lo imposible ocurre. â€” Gustavo'},
   ]},
  {id:16,name:'DimensiÃ³n Pastelera',icon:'ğŸŒ€',color:'rgba(99,102,241,.16)',levels:[451,480],rivalLevel:480,
   desc:'El futuro de la reposterÃ­a. TecnologÃ­a e ingredientes del maÃ±ana.',
   bakeryName:'Bakery 4D Â· Realidad Aumentada',
   story:[
     {at:451,ep:'CAP 16',icon:'ğŸŒ€',title:'La PastelerÃ­a del Futuro',text:'Un laboratorio de Silicon Valley te invita a colaborar. Impresoras 3D de chocolate, ingredientes que cambian de sabor con la temperatura corporal, macarons que se iluminan al morderlos.',quote:'El futuro del sabor ya estaba escrito en el pasado. â€” RosalÃ­a, sin fecha'},
     {at:466,ep:'CAP 16Â·II',icon:'ğŸŒ€',title:'La IA Pastelera',text:'Una empresa de inteligencia artificial ha entrenado un modelo con cinco millones de recetas. La prensa dice que ha hecho obsoleta la intuiciÃ³n humana. TÃº sabes que estÃ¡n equivocados.',quote:'La IA sabe quÃ© ingredientes van bien juntos. Pero no sabe por quÃ© la abuela aÃ±adÃ­a mÃ¡s amor. â€” TÃº'},
   ]},
  {id:17,name:'Los Pasteles del Tiempo',icon:'â³',color:'rgba(245,158,11,.22)',levels:[481,510],rivalLevel:510,
   desc:'Recetas de civilizaciones olvidadas. El pasado tiene sabores pendientes.',
   bakeryName:'Temporis Â· ReposterÃ­a Ancestral',
   story:[
     {at:481,ep:'CAP 17',icon:'â³',title:'Las Recetas Perdidas',text:'Un arqueÃ³logo llega con tablillas de arcilla que parecen recetas de la antigua Mesopotamia. El azÃºcar en el aÃ±o 3000 a.C. era tan valioso como el oro. Al contacto con las tablillas, el cuaderno de RosalÃ­a empieza a vibrar.',quote:'El azÃºcar siempre fue sagrado. Los humanos tardaron milenios en democratizarlo. â€” Dr. Aldama'},
     {at:496,ep:'CAP 17Â·II',icon:'â³',title:'El GuardiÃ¡n del Tiempo',text:'En las catacumbas de Roma encuentras un taller de reposterÃ­a conservado del siglo I d.C. El guardiÃ¡n lleva milenios custodiando la receta de un pastel que el emperador NerÃ³n ordenÃ³ nunca abandonara esas paredes.',quote:'Algunos pasteles no se hacen para comerlos. Se hacen para guardarlos. â€” El GuardiÃ¡n'},
   ]},
  {id:18,name:'El Olimpo del Sabor',icon:'âš¡',color:'rgba(52,211,153,.16)',levels:[511,540],rivalLevel:540,
   desc:'Compites con los mejores del planeta. El camino al nÃºmero uno.',
   bakeryName:'Olympia Â· PastelerÃ­a de los Dioses',
   story:[
     {at:511,ep:'CAP 18',icon:'âš¡',title:'El Torneo de los Titanes',text:'El Torneo Mundial de ReposterÃ­a. Ocho semifinalistas, cuatro continentes. Tres dÃ­as de competiciÃ³n con ingredientes imposibles, tiempos imposibles y jueces imposibles.',quote:'David nunca necesitÃ³ el mismo equipo que Goliat. â€” Nota en el camerino'},
     {at:526,ep:'CAP 18Â·II',icon:'âš¡',title:'La Gran Final',text:'La final: solo tÃº y el campeÃ³n defensor Maestro Viktor Orenburg, campeÃ³n siete aÃ±os consecutivos. Su paleta detecta 0.1g de diferencia en azÃºcar. Lleva aÃ±os esperando a alguien que le haga sudar.',quote:'La verdadera competiciÃ³n no es contra el otro. Es contra la versiÃ³n de ti que se rinde. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:19,name:'El Legado de RosalÃ­a',icon:'âœ¨',color:'rgba(192,132,252,.18)',levels:[541,570],rivalLevel:570,
   desc:'Tu misiÃ³n ahora es preservar y transmitir. El mundo necesita el cuaderno.',
   bakeryName:'FundaciÃ³n RosalÃ­a Â· El Legado',
   story:[
     {at:541,ep:'CAP 19',icon:'âœ¨',title:'La FundaciÃ³n',text:'Creas la FundaciÃ³n RosalÃ­a: escuelas de reposterÃ­a gratuitas en cuarenta paÃ­ses, becas para cocineros sin recursos, expediciones para recuperar recetas en peligro de extinciÃ³n.',quote:'No heredas el cuaderno para guardarlo. Lo heredas para multiplicarlo. â€” TÃº'},
     {at:556,ep:'CAP 19Â·II',icon:'âœ¨',title:'El Coleccionista',text:'Desde las sombras emerge el verdadero antagonista: El Coleccionista lleva dÃ©cadas comprando y ocultando recetas Ãºnicas. Tiene el 90% del patrimonio gastronÃ³mico mundial bajo llave.',quote:'El conocimiento que se esconde muere. El que se comparte, vive para siempre. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:20,name:'El Pastel Infinito',icon:'ğŸŒŸ',color:'rgba(251,191,36,.22)',levels:[571,600],rivalLevel:600,
   desc:'El final del segundo arco. La receta que justifica todo el viaje.',
   bakeryName:'Infinito ROSALÃA Â· La Eternidad del Sabor',
   story:[
     {at:571,ep:'CAP 20',icon:'ğŸŒŸ',title:'La Receta Final',text:'El cuaderno tiene una Ãºltima pÃ¡gina que nunca pudiste leer: el papel era tan delgado que parecÃ­a transparente. Hoy, con la luz de la luna llena, la tinta aparece. Son apenas cuatro lÃ­neas que cambian todo.',quote:'La receta mÃ¡s importante nunca fue de azÃºcar. Fue de tiempo, paciencia y amor. Y las tienes todas. â€” RosalÃ­a'},
     {at:586,ep:'CAP 20Â·II',icon:'ğŸŒŸ',title:'El Pastel Infinito',text:'Lo hiciste. No solo construiste una pastelerÃ­a. Construiste un mundo donde la gente va a ser feliz. Cada macaron imperfecto fue un maestro. El cuaderno estÃ¡ ahora lleno.',quote:'El mejor pastel del mundo es el que compartes. â€” TÃº, ahora'},
   ]},
  {id:21,name:'La Ruta de la Seda Dulce',icon:'ğŸ²',color:'rgba(239,68,68,.16)',levels:[601,630],rivalLevel:630,
   desc:'La Ruta de la Seda esconde recetas milenarias que nadie ha probado.',
   bakeryName:'Ruta RosalÃ­a Â· Asia Central',
   story:[
     {at:601,ep:'CAP 21',icon:'ğŸ²',title:'El Pergamino de Khan',text:'En un bazar de Samarcanda encuentras un pergamino con instrucciones para un pastel de dÃ¡til y azafrÃ¡n que sirvieron al mismÃ­simo Kublai Khan. El cuaderno vibra tanto que casi se cae de tus manos.',quote:'Hay sabores que atraviesan el tiempo y los imperios sin perderse. â€” Anciano del bazar'},
     {at:616,ep:'CAP 21Â·II',icon:'ğŸ²',title:'La SeÃ±ora del Camino',text:'Zeynep lleva cuarenta aÃ±os preparando los mejores dulces de mantequilla de la regiÃ³n. Dice que nadie puede usar las recetas del Khan sin haber demostrado antes que las merece.',quote:'Las recetas del Khan no se comen. Se ganan. â€” Zeynep'},
   ]},
  {id:22,name:'La PastelerÃ­a Africana',icon:'ğŸŒ',color:'rgba(245,158,11,.20)',levels:[631,660],rivalLevel:660,
   desc:'El continente africano guarda los sabores mÃ¡s antiguos del mundo.',
   bakeryName:'Ubuntu Bakery Â· Ãfrica',
   story:[
     {at:631,ep:'CAP 22',icon:'ğŸŒ',title:'El Sabor Ubuntu',text:'Lagos, Marrakech, El Cairo, Addis Abeba. Cuatro ciudades, cuatro filosofÃ­as del dulce completamente distintas. Ubuntu significa que somos personas gracias a las demÃ¡s. Tus pasteles empiezan a saber a comunidad.',quote:'Ubuntu: soy lo que soy porque nosotros somos. â€” Proverbio zulÃº'},
     {at:646,ep:'CAP 22Â·II',icon:'ğŸŒ',title:'La Matriarca del Desierto',text:'Amara lleva setenta aÃ±os preparando injera dulce para bodas y funerales en EtiopÃ­a. Cuando prueba tu versiÃ³n de su receta, se rÃ­e tan fuerte que tres vecinas vienen a ver quÃ© pasa.',quote:'La risa y el azÃºcar son los Ãºnicos idiomas sin fronteras. â€” Amara'},
   ]},
  {id:23,name:'Cocina de Autor',icon:'ğŸ¨',color:'rgba(168,85,247,.20)',levels:[661,690],rivalLevel:690,
   desc:'La reposterÃ­a como arte contemporÃ¡neo. Museos, galerÃ­as y sabor.',
   bakeryName:'RosalÃ­a Avant-Garde Â· Arte Comestible',
   story:[
     {at:661,ep:'CAP 23',icon:'ğŸ¨',title:'El Pastel en el Museo',text:'El Museo de Arte ContemporÃ¡neo de Nueva York te encarga una instalaciÃ³n comestible: una obra que dure exactamente setenta y dos horas antes de disolverse. El reto: que la gente llore cuando desaparezca.',quote:'El arte mÃ¡s honesto es el que se va. El mÃ¡s valiente es el que te hace querer quedarte. â€” Comisaria del MoMA'},
     {at:676,ep:'CAP 23Â·II',icon:'ğŸ¨',title:'El CrÃ­tico de Arte',text:'Marco Stern lleva veinte aÃ±os destruyendo artistas emergentes con una frase. Ahora estÃ¡ frente a tu instalaciÃ³n con los brazos cruzados y, sin querer, un apetito que no tenÃ­a desde hace aÃ±os.',quote:'Todo arte que se puede comer es honesto. El resto es decoraciÃ³n. â€” Marco Stern, tras probar'},
   ]},
  {id:24,name:'La PastelerÃ­a NÃ³rdica',icon:'â„ï¸',color:'rgba(59,130,246,.18)',levels:[691,720],rivalLevel:720,
   desc:'El hygge escandinavo y la filosofÃ­a del bienestar a travÃ©s del dulce.',
   bakeryName:'Hygge Bakery Â· Escandinavia',
   story:[
     {at:691,ep:'CAP 24',icon:'â„ï¸',title:'El Secreto del Hygge',text:'Estocolmo en diciembre. La oscuridad cae a las tres de la tarde. Pero cada pastelerÃ­a brilla como una pequeÃ±a promesa de luz. El hygge no es una receta. Es un estado de Ã¡nimo que los suecos meten dentro de la mantequilla.',quote:'El hygge no se explica. Se hornea. â€” Lars, maestro pastelero de Copenhague'},
     {at:706,ep:'CAP 24Â·II',icon:'â„ï¸',title:'La Vikinga del AzÃºcar',text:'Ingrid lleva treinta aÃ±os haciendo los mejores kanelbullar del mundo en un pueblo de doscientas personas. Nunca ha querido expandirse. La escala destruye el sabor. Quiere demostrÃ¡rtelo.',quote:'Hay pasteles que solo saben bien cuando los haces en cantidades pequeÃ±as y con el corazÃ³n grande. â€” Ingrid'},
   ]},
  {id:25,name:'El Renacimiento Italiano',icon:'ğŸ•',color:'rgba(244,63,94,.16)',levels:[721,750],rivalLevel:750,
   desc:'La reposterÃ­a italiana y el arte de la vida dulce en Florencia.',
   bakeryName:'Dolce Vita RosalÃ­a Â· Italia',
   story:[
     {at:721,ep:'CAP 25',icon:'ğŸ•',title:'Florencia y el Sabor del Arte',text:'Florencia en primavera huele a glicinas y sfogliatelle. Cada pastelerÃ­a es un museo, cada pastelero un artista que heredÃ³ su arte de alguien que lo heredÃ³ de otro. El cuaderno empieza a escribirse en italiano.',quote:'In Italia, non si mangia. Si vive attraverso il cibo. â€” Nonno Bianchi'},
     {at:736,ep:'CAP 25Â·II',icon:'ğŸ•',title:'La Nonna de Napoli',text:'Concetta tiene noventa y dos aÃ±os, doce nietos y la mejor ricotta del mundo. Setenta aÃ±os haciendo la misma sfogliatella. Cuando prueba la tuya dice solo: Casi. Y eso, de Concetta, vale un premio internacional.',quote:'Casi perfecto es lo mÃ¡ximo que le digo a alguien que no sea mi difunto marido. â€” Concetta'},
   ]},
  {id:26,name:'La Gran ExposiciÃ³n',icon:'ğŸ›ï¸',color:'rgba(251,191,36,.22)',levels:[751,780],rivalLevel:780,
   desc:'Una exposiciÃ³n mundial donde tu historia se convierte en leyenda.',
   bakeryName:'Expo RosalÃ­a Â· Muestra Mundial',
   story:[
     {at:751,ep:'CAP 26',icon:'ğŸ›ï¸',title:'El Gran PabellÃ³n',text:'La ExposiciÃ³n Universal de la GastronomÃ­a. Noventa paÃ­ses, un pabellÃ³n cada uno. El tuyo representa no solo una pastelerÃ­a sino una filosofÃ­a: que el dulce es el lenguaje mÃ¡s democrÃ¡tico del mundo.',quote:'Una exposiciÃ³n universal no exhibe lo que tienes. Exhibe quiÃ©n eres. â€” Directora de la ExposiciÃ³n'},
     {at:766,ep:'CAP 26Â·II',icon:'ğŸ›ï¸',title:'El Rival de las Naciones',text:'El gran rival de esta exposiciÃ³n no es una persona. Es el miedo: noventa paÃ­ses con siglos de tradiciÃ³n gastronÃ³mica frente a una pastelera que empezÃ³ en una cocina de madera.',quote:'La cocina mÃ¡s poderosa del mundo no es la que tiene mÃ¡s medallas. Es la que tiene mÃ¡s amor. â€” Cuaderno de RosalÃ­a'},
   ]},
  {id:27,name:'El Secreto de los Templos',icon:'ğŸ›•',color:'rgba(236,72,153,.20)',levels:[781,810],rivalLevel:810,
   desc:'Los dulces sagrados de los templos de Asia guardan el Ãºltimo misterio.',
   bakeryName:'Temple Sweet RosalÃ­a Â· Oriente',
   story:[
     {at:781,ep:'CAP 27',icon:'ğŸ›•',title:'El Monje Pastelero',text:'En un monasterio budista de Tailandia, un monje de ciento cuatro aÃ±os hace los mismos dulces de arroz pegajoso desde los diecisÃ©is. Al cuarto dÃ­a te invita a su cocina y te enseÃ±a el silencio como ingrediente.',quote:'El silencio es el Ãºnico ingrediente que no tiene sustituto. â€” Monje Phra Somchai'},
     {at:796,ep:'CAP 27Â·II',icon:'ğŸ›•',title:'La Guardiana del Templo',text:'Wan lleva cincuenta aÃ±os protegiendo las recetas sagradas del templo de intrusos. Para convencerla de que tus intenciones son puras tendrÃ¡s que demostrar algo que no se puede forzar.',quote:'Las recetas sagradas no se dan. Se reconocen en quien ya las lleva dentro. â€” Wan'},
   ]},
  {id:28,name:'La Ãšltima Frontera',icon:'ğŸš€',color:'rgba(99,102,241,.18)',levels:[811,840],rivalLevel:840,
   desc:'La reposterÃ­a llega al espacio. El Ãºltimo territorio inexplorado del dulce.',
   bakeryName:'Space Bakery RosalÃ­a Â· Ã“rbita',
   story:[
     {at:811,ep:'CAP 28',icon:'ğŸš€',title:'El Pastel en Ã“rbita',text:'La Agencia Espacial Mundial te encomienda una misiÃ³n histÃ³rica: crear el primer postre que pueda hornearse en microgravedad. Sin horno convencional. Sin gravedad para que suba la masa.',quote:'Si la humanidad lleva el azÃºcar al espacio, lleva tambiÃ©n la esperanza. â€” Comandante de la misiÃ³n'},
     {at:826,ep:'CAP 28Â·II',icon:'ğŸš€',title:'El Ingeniero del Cero G',text:'El Dr. Nakashima dice que la reposterÃ­a en el espacio es fÃ­sicamente imposible de hacer bien. La ciencia tiene lÃ­mites. TÃº tambiÃ©n tienes una teorÃ­a: el cuaderno de RosalÃ­a nunca ha necesitado fÃ­sica.',quote:'La fÃ­sica dice que esto no puede funcionar. Pero la fÃ­sica no conocÃ­a a tu abuela. â€” TÃº'},
   ]},
  {id:29,name:'El Tribunal del Sabor',icon:'âš–ï¸',color:'rgba(52,211,153,.18)',levels:[841,870],rivalLevel:870,
   desc:'El tribunal mÃ¡s alto del mundo gastronÃ³mico examina tu legado completo.',
   bakeryName:'Suprema PastelerÃ­a RosalÃ­a',
   story:[
     {at:841,ep:'CAP 29',icon:'âš–ï¸',title:'El Juicio del Sabor',text:'El Tribunal del Sabor es convocado una vez cada veinte aÃ±os para examinar si una pastelerÃ­a merece el rango de Patrimonio Inmaterial de la Humanidad. Catorce jueces de catorce paÃ­ses. Tu expediente tiene novecientos niveles de recetas.',quote:'No juzgamos solo lo que hacÃ©is. Juzgamos por quÃ© lo hacÃ©is. â€” Presidenta del Tribunal'},
     {at:856,ep:'CAP 29Â·II',icon:'âš–ï¸',title:'El Juez de los Jueces',text:'El Juez Supremo lleva cuarenta aÃ±os en el tribunal y nunca ha votado a favor de nadie. Cree que la perfecciÃ³n es una arrogancia y que todo lo hecho por manos humanas contiene al menos un defecto.',quote:'Un defecto en lo hecho con amor no es un fallo. Es una firma. â€” El Juez, en voz baja'},
   ]},
  {id:30,name:'El Pastel Eterno',icon:'ğŸŒŒ',color:'rgba(251,191,36,.25)',levels:[871,900],rivalLevel:900,
   desc:'El capÃ­tulo final. La receta que no tiene nombre. El pastel que lo contiene todo.',
   bakeryName:'Eternidad ROSALÃA Â· La Receta Final',
   story:[
     {at:871,ep:'CAP 30',icon:'ğŸŒŒ',title:'El Origen del Dulce',text:'Encuentras la Ãºltima pÃ¡gina del cuaderno de RosalÃ­a, la que nunca existiÃ³. En ella, la escritura no es de tu abuela. Es tuya. Escrita por ti antes de que nacieras. La receta del primer dulce del mundo.',quote:'No eres la heredera de una receta. Eres la receta. â€” Voz que solo tÃº puedes oÃ­r'},
     {at:886,ep:'CAP 30Â·II',icon:'ğŸŒŒ',title:'El Pastel Eterno',text:'No hay rival. No hay juez. Solo tÃº, el cuaderno, y el horno de madera que heredaste de RosalÃ­a. El mismo de madera con el que empezaste. AÃºn tan caprichoso como el primer dÃ­a. Pero ahora os entendÃ©is.',quote:'El pastel mÃ¡s importante de tu vida no serÃ¡ el mÃ¡s perfecto. SerÃ¡ el que hiciste con mÃ¡s amor. â€” Cuaderno de RosalÃ­a'},
   ]}
];

// â”€â”€â”€ STORY FLAT â”€â”€â”€
const ALL_STORIES={};
CHAPTERS.forEach(ch=>ch.story.forEach(s=>{ALL_STORIES[s.at]=s;}));

// â”€â”€â”€ BAKERY NAMES â”€â”€â”€
const BAKERY_NAMES=CHAPTERS.map(c=>c.bakeryName);

// â”€â”€â”€ 30 RIVALS â”€â”€â”€
const RIVALS=[
  {id:1,level:30,name:'INSPECTOR GRUNWALD',title:'El Terror Sanitario',icon:'ğŸ•µï¸',hp:12,maxHp:12,
   lore:'Lleva 25 aÃ±os cerrando obradores que no alcanzan sus estÃ¡ndares. Nunca ha dado una puntuaciÃ³n perfecta. Odia los principiantes con demasiado entusiasmo.',
   attacks:[{name:'Orden de Cierre',emoji:'ğŸ“‹',desc:'Congela una fila de ingredientes',id:'freezeRow'},{name:'Multa Sanitaria',emoji:'âš ï¸',desc:'Quita 2 turnos',id:'timePenalty'}],
   winLore:'Grunwald se marcha mascullando. Tres dÃ­as despuÃ©s llega una carta: 8.5/10. En 25 aÃ±os nunca habÃ­a dado mÃ¡s de 7.'},
  {id:2,level:60,name:'CHEF RIVALINO HIJO',title:'El Heredero Ambicioso',icon:'ğŸ‘¨â€ğŸ³',hp:16,maxHp:16,
   lore:'EstudiÃ³ cinco aÃ±os en ParÃ­s con la promesa de acabar con tu tienda. Tiene tÃ©cnica perfecta. Le falta lo que no se enseÃ±a.',
   attacks:[{name:'TÃ©cnica Parisina',emoji:'ğŸ¥–',desc:'Invierte los tiers del tablero',id:'invertBoard'},{name:'Robo de Receta',emoji:'ğŸ“„',desc:'Fondant a 3 ingredientes',id:'addShields'},{name:'Sabotaje',emoji:'ğŸ’€',desc:'Corrompe 2 ingredientes',id:'curseTwo'}],
   winLore:'Mi padre tenÃ­a razÃ³n. La tÃ©cnica sin alma es cocina industrial. Ese mes anuncia que cierra la pastelerÃ­a familiar para estudiar contigo.'},
  {id:3,level:90,name:'VALENTINA DURA',title:'La CrÃ­tica Sin Piedad',icon:'âœï¸',hp:20,maxHp:20,
   lore:'Veinte aÃ±os destruyendo reputaciones culinarias con cuatro palabras. Su libreta negra es el objeto mÃ¡s temido del sector. Nunca ha dado cinco estrellas.',
   attacks:[{name:'CrÃ­tica Devastadora',emoji:'â­',desc:'Baja 2 tiers a ingredientes',id:'witherTwo'},{name:'ArtÃ­culo Viral',emoji:'ğŸ“°',desc:'Envenena toda una columna',id:'poisonCol'},{name:'Cero Estrellas',emoji:'ğŸ’¢',desc:'Destruye el ingrediente mÃ¡s avanzado',id:'consumeMax'}],
   winLore:'Interesante. Es lo mÃ¡s que ha dicho en dos dÃ©cadas. La semana siguiente publica: Cinco estrellas. Sin palabras.'},
  {id:4,level:120,name:'MADAME CROÃ›TON',title:'La Baronesa del Flan',icon:'ğŸ‘¸',hp:25,maxHp:25,
   lore:'Treinta aÃ±os convencida de que la reposterÃ­a francesa es la Ãºnica que merece existir. No soporta que alguien mezcle culturas.',
   attacks:[{name:'MÃ©pris FranÃ§ais',emoji:'ğŸ‡«ğŸ‡·',desc:'Mezcla y degrada el tablero',id:'degradeShuffle'},{name:'Orden del Flan',emoji:'ğŸ®',desc:'Destruye en forma de cruz',id:'crossDestroy'},{name:'BarriÃ¨re Culturelle',emoji:'ğŸ›¡ï¸',desc:'Fondant a 4 ingredientes',id:'addShields'},{name:'DÃ©dain Total',emoji:'ğŸ’…',desc:'Corrompe una fila entera',id:'curseRow'}],
   winLore:'Ma grand-mÃ¨re hacÃ­a algo asÃ­. Ahora creo que hay algo mÃ¡s grande que cualquier frontera. JamÃ¡s ha dicho tanto en pÃºblico.'},
  {id:5,level:150,name:'SR. AZÃšCAR CERO',title:'El Rey del Fast Cake',icon:'ğŸ­',hp:30,maxHp:30,
   lore:'Su empresa produce dos millones de pasteles industriales al dÃ­a. Todos iguales. Sin sabor. Pero baratos.',
   attacks:[{name:'ProducciÃ³n Masiva',emoji:'ğŸ­',desc:'Llena el tablero de bÃ¡sicos',id:'massBasic'},{name:'CampaÃ±a de Precios',emoji:'ğŸ’¸',desc:'Doble ataque',id:'doubleAttack'},{name:'Conservantes',emoji:'â˜ ï¸',desc:'Congela e infecta',id:'sporeFrost'},{name:'Monopolio',emoji:'ğŸ”’',desc:'Fondant a 3 ingredientes',id:'addShields'}],
   winLore:'Sus ventas bajan un 40%. CÃ³mo es posible. Nunca lo entenderÃ¡.'},
  {id:6,level:180,name:'LA BRUJA DEL AZÃšCAR',title:'La ConfiterÃ¡ Oscura',icon:'ğŸ§™â€â™€ï¸',hp:35,maxHp:35,
   lore:'Nadie sabe su verdadero nombre. Lleva cuarenta aÃ±os dominando los encargos de Ã©lite con mÃ©todos que van mÃ¡s allÃ¡ de los ingredientes.',
   attacks:[{name:'Hechizo de Malos Ratos',emoji:'ğŸŒ‘',desc:'Congela las 4 esquinas',id:'darkThought'},{name:'MaldiciÃ³n Dulce',emoji:'ğŸ’€',desc:'Corrompe 3 ingredientes',id:'curseThree'},{name:'Espejo Roto',emoji:'ğŸª',desc:'Tiers cambian aleatoriamente',id:'paradox'},{name:'AbsorciÃ³n',emoji:'ğŸ§²',desc:'PrÃ³ximo combo anulado',id:'comboAbsorb'},{name:'Tarta Venenosa',emoji:'â˜ ï¸',desc:'Destruye el mÃ¡s poderoso',id:'consumeMax'}],
   winLore:'Tu abuela RosalÃ­a y yo fuimos amigas. Antes de que la ambiciÃ³n nos separara. Guarda bien ese cuaderno.'},
  {id:7,level:210,name:'GRAN MAESTRO CONFITERO',title:'El GuardiÃ¡n de la TradiciÃ³n',icon:'ğŸ©',hp:40,maxHp:40,
   lore:'Cincuenta aÃ±os custodiando los estÃ¡ndares oficiales. Ha certificado 3.000 pastelerÃ­as y rechazado 12.000.',
   attacks:[{name:'Examen Oral',emoji:'ğŸ“',desc:'Congela fila y degrada otra',id:'freezeAndDegrade'},{name:'Punto y Aparte',emoji:'âœï¸',desc:'Aumenta el objetivo',id:'rewriteObj'},{name:'TradiciÃ³n Estricta',emoji:'ğŸ“',desc:'Invierte los tiers',id:'invertBoard'},{name:'La Receta Perdida',emoji:'ğŸ“œ',desc:'Mezcla y degrada',id:'degradeShuffle'},{name:'CertificaciÃ³n Final',emoji:'ğŸ…',desc:'Destruye 5 ingredientes',id:'finalNova'}],
   winLore:'CERTIFICADO CON HONORES. SonrÃ­e por primera y Ãºltima vez en cincuenta aÃ±os de carrera.'},
  {id:8,level:240,name:'JUEZA MADAME FLEURY',title:'La Impasible',icon:'âš–ï¸',hp:45,maxHp:45,
   lore:'Veinte aÃ±os de jueza principal. Nunca ha dado el primer premio. Dice que la perfecciÃ³n no se puede hornear.',
   attacks:[{name:'Criterio Imposible',emoji:'ğŸ”',desc:'Elimina un tipo de ingrediente',id:'eraseTier'},{name:'Punto de PrecisiÃ³n',emoji:'âš–ï¸',desc:'Quita 3 turnos',id:'timePenalty3'},{name:'ComparaciÃ³n',emoji:'ğŸ’­',desc:'Revierte el tablero',id:'timeRevert'},{name:'El Silencio',emoji:'ğŸ¤«',desc:'Absorbe tu combo',id:'comboAbsorb'},{name:'PuntuaciÃ³n Cero',emoji:'0ï¸âƒ£',desc:'Degrada fila y columna',id:'hiveMind'},{name:'El Veredicto',emoji:'ğŸ”¨',desc:'Destruye 6 ingredientes',id:'theFracture'}],
   winLore:'Se levanta de su silla. Aplaude. Una vez. Muestra la puntuaciÃ³n: 10/10.'},
  {id:9,level:270,name:'BARÃ“N DEL CHOCOLATE',title:'El Monopolista del Cacao',icon:'ğŸ©',hp:50,maxHp:50,
   lore:'Controla el 60% de la producciÃ³n mundial de cacao. Ha comprado a tus proveedores.',
   attacks:[{name:'Bloqueo de Suministro',emoji:'ğŸš«',desc:'Congela fila y fondant a otra',id:'freezeAndShield'},{name:'Precio del Monopolio',emoji:'ğŸ’°',desc:'Doble ataque',id:'doubleAttack'},{name:'Cacao Amargo',emoji:'ğŸ˜¤',desc:'Degrada una fila',id:'shockwave'},{name:'Contrato',emoji:'ğŸ“„',desc:'Los poderes cuestan mÃ¡s',id:'doubleRules'},{name:'Monopolio Total',emoji:'ğŸŒ',desc:'Destruye 8 ingredientes',id:'theFracture'}],
   winLore:'El ingrediente secreto no estÃ¡ en el cacao. EstÃ¡ en para quiÃ©n lo haces.'},
  {id:10,level:300,name:'EL GRAN CHEF',title:'El Origen de Todas las Recetas',icon:'ğŸ‘‘',hp:60,maxHp:60,
   lore:'Existe desde que la humanidad aprendiÃ³ a mezclar dos cosas para crear algo nuevo. El examen final. No de tÃ©cnica. De alma.',
   attacks:[{name:'La Pregunta Eterna',emoji:'â“',desc:'Elimina un tipo',id:'eraseTier'},{name:'El Tiempo Vuela',emoji:'â°',desc:'Quita 5 turnos',id:'timePenalty5'},{name:'Receta Perdida',emoji:'ğŸ“œ',desc:'Invierte y mezcla',id:'invertShuffle'},{name:'Prueba del Alma',emoji:'ğŸ’›',desc:'Degrada fila y columna',id:'hiveMind'},{name:'LA GRAN DEGUSTACIÃ“N',emoji:'ğŸ°',desc:'SUPREMO! Destruye 10',id:'supremeAttack'}],
   winLore:'Ya no necesitas el cuaderno. Ya eres la receta.'},
  {id:11,level:330,name:'COLETTE MERVEILLE',title:'La Reina de los Macarons',icon:'ğŸ‘’',hp:38,maxHp:38,
   lore:'Cincuenta aÃ±os siendo la maestra indiscutible del macaron parisino. Un ojo detecta imperfecciones a seis metros.',
   attacks:[{name:'Ojo ClÃ­nico',emoji:'ğŸ‘ï¸',desc:'Destruye los mejores ingredientes',id:'consumeMax'},{name:'PresiÃ³n Parisina',emoji:'ğŸ—¼',desc:'Congela 2 filas',id:'freezeTwoRows'},{name:'Critique SÃ©vÃ¨re',emoji:'ğŸ“‹',desc:'Degrada y mezcla',id:'degradeShuffle'},{name:'Standard Absolu',emoji:'â­',desc:'Aumenta el objetivo',id:'rewriteObj'}],
   winLore:'Merde. En cincuenta aÃ±os nunca habÃ­a dicho esa palabra. Significa que eres buena.'},
  {id:12,level:360,name:'GREMIO CHOCOLATERO',title:'Los Guardianes del Cacao',icon:'ğŸ›ï¸',hp:42,maxHp:42,
   lore:'La organizaciÃ³n mÃ¡s exclusiva del mundo del cacao. El perdedor del duelo debe abandonar Brujas.',
   attacks:[{name:'Protocolo Belga',emoji:'ğŸ‡§ğŸ‡ª',desc:'Invierte los tiers',id:'invertBoard'},{name:'Amargo Puro',emoji:'ğŸ˜–',desc:'Degrada columna entera',id:'hiveMind'},{name:'Secreto Gremial',emoji:'ğŸ”',desc:'Fondant a 5 ingredientes',id:'addShields'},{name:'Sentencia del Gremio',emoji:'âš–ï¸',desc:'Destruye 7 ingredientes',id:'theFracture'}],
   winLore:'Jacques llora. Cuando Jacques llora sÃ© que ganaste. Recibes el sello del Gremio.'},
  {id:13,level:390,name:'MAESTRO TAKAHASHI',title:'El Sensei del Wagashi',icon:'ğŸ‹',hp:46,maxHp:46,
   lore:'Maestro en wagashi. Cree que la forma de un dulce es tan importante como su sabor.',
   attacks:[{name:'Wabi-Sabi',emoji:'ğŸ‚',desc:'Corrompe ingredientes seleccionados',id:'curseThree'},{name:'Zen Implacable',emoji:'ğŸ§˜',desc:'Congela y degrada',id:'freezeAndDegrade'},{name:'ArmonÃ­a Rota',emoji:'ğŸ’”',desc:'Mezcla y corrompe',id:'degradeShuffle'},{name:'Mono no Aware',emoji:'ğŸŒ¸',desc:'Doble ataque',id:'doubleAttack'},{name:'El Maestro Habla',emoji:'ğŸ“¿',desc:'Destruye 6 ingredientes',id:'theFracture'}],
   winLore:'Entendiste el mono no aware. La melancolÃ­a de las cosas hermosas que terminan. Eso ya no se puede enseÃ±ar.'},
  {id:14,level:420,name:'FATIMA AL-RASHID',title:'La Sultana del Baklava',icon:'ğŸŒ™',hp:50,maxHp:50,
   lore:'Cuatro generaciones preparando baklava para la realeza. Su secreto familiar estÃ¡ protegido por juramentos del siglo XIV.',
   attacks:[{name:'Secreto de Familia',emoji:'ğŸ¤«',desc:'Invierte y congela',id:'invertAndFreeze'},{name:'Miel Venenada',emoji:'ğŸ¯',desc:'Corrompe una fila entera',id:'curseRow'},{name:'Pasta Filo Letal',emoji:'ğŸŒ€',desc:'Destruye en espiral',id:'vortex'},{name:'Magia del Zoco',emoji:'âœ¨',desc:'Tiers aleatorios',id:'paradox'},{name:'El Juramento',emoji:'âš”ï¸',desc:'Destruye 8 ingredientes',id:'theFracture'}],
   winLore:'DÃ³nde encontraste esa receta. Silencio largo. Finalmente: Tu abuela tambiÃ©n pasÃ³ por el zoco.'},
  {id:15,level:450,name:'GUSTAVO EL MAGNÃFICO',title:'El Mago del Fondant',icon:'ğŸ©',hp:55,maxHp:55,
   lore:'Veinte aÃ±os creando esculturas comestibles que desafÃ­an la fÃ­sica. Te desafÃ­a en directo con un millÃ³n de espectadores.',
   attacks:[{name:'Truco de Magia',emoji:'ğŸ©',desc:'Convierte tiles aleatoriamente',id:'paradox'},{name:'IlusiÃ³n Ã“ptica',emoji:'ğŸŒ€',desc:'Invierte el tablero',id:'invertBoard'},{name:'El Conejo',emoji:'ğŸ°',desc:'Fondant a 4 ingredientes',id:'addShields'},{name:'El ClÃ­max',emoji:'ğŸ’¥',desc:'Doble ataque',id:'doubleAttack'},{name:'El Gran Final',emoji:'ğŸ†',desc:'Destruye 9 ingredientes',id:'theFracture'}],
   winLore:'El pÃºblico enloquece. Gustavo se quita el sombrero y hace una reverencia hacia ti. Nunca lo habÃ­a hecho.'},
  {id:16,level:480,name:'LA IA PASTELERA',title:'El Algoritmo del Sabor',icon:'ğŸ¤–',hp:60,maxHp:60,
   lore:'Entrenada con cinco millones de recetas. Puede crear cualquier combinaciÃ³n matemÃ¡ticamente Ã³ptima. Pero no puede sentir.',
   attacks:[{name:'Algoritmo v1',emoji:'ğŸ’»',desc:'Reorganiza el tablero',id:'degradeShuffle'},{name:'OptimizaciÃ³n',emoji:'ğŸ“Š',desc:'Elimina los menos eficientes',id:'consumeMax'},{name:'Loop de Error',emoji:'ğŸ”„',desc:'Revierte y congela',id:'timeRevert'},{name:'Deep Learning',emoji:'ğŸ§ ',desc:'Aumenta objetivo un 50%',id:'rewriteObj'},{name:'OVERFITTING',emoji:'âš¡',desc:'Destruye 10 ingredientes',id:'supremeAttack'}],
   winLore:'ERROR: INTUICIÃ“N_HUMANA no encontrada en dataset. Por primera vez, la IA no tiene respuesta.'},
  {id:17,level:510,name:'GUARDIÃN DEL TIEMPO',title:'El Custodio Milenario',icon:'âŒ›',hp:65,maxHp:65,
   lore:'Ha custodiado recetas de civilizaciones antiguas durante milenios. No le hace gracia que alguien las use.',
   attacks:[{name:'ErosiÃ³n del Tiempo',emoji:'ğŸŒŠ',desc:'Degrada todos los ingredientes',id:'allDegrade'},{name:'Paradoja Temporal',emoji:'â™¾ï¸',desc:'El tablero retrocede',id:'timeRevert'},{name:'Polvo de Siglos',emoji:'ğŸ’¨',desc:'Congela el tablero',id:'freezeAll'},{name:'Juicio Eterno',emoji:'âš–ï¸',desc:'Elimina el tipo mÃ¡s frecuente',id:'eraseTier'},{name:'LA ETERNIDAD',emoji:'ğŸŒŒ',desc:'Destruye 12 ingredientes',id:'theFracture'}],
   winLore:'Dos mil aÃ±os custodiando estas recetas. Nunca pensÃ© que vendrÃ­a alguien capaz de merecerlas.'},
  {id:18,level:540,name:'MAESTRO VIKTOR ORENBURG',title:'El CampeÃ³n Imbatible',icon:'ğŸ†',hp:70,maxHp:70,
   lore:'Siete aÃ±os campeÃ³n consecutivo del Torneo Mundial. Su paleta gustativa detecta 0.1g de diferencia en azÃºcar.',
   attacks:[{name:'PrecisiÃ³n MilimÃ©trica',emoji:'ğŸ“',desc:'Degrada fila y columna',id:'hiveMind'},{name:'TÃ©cnica Perfecta',emoji:'ğŸ’¯',desc:'Invierte y congela',id:'invertAndFreeze'},{name:'Paleta Suprema',emoji:'ğŸ‘…',desc:'Elimina el mejor tipo',id:'eraseTier'},{name:'CampeÃ³n de Campeones',emoji:'ğŸ¥‡',desc:'Doble ataque',id:'doubleAttack'},{name:'SIETE AÃ‘OS',emoji:'âš¡',desc:'Destruye 12 ingredientes',id:'theFracture'}],
   winLore:'Por primera vez en siete aÃ±os, Viktor Orenburg suda. Extiende la mano: Sucesor.'},
  {id:19,level:570,name:'EL COLECCIONISTA',title:'El LadrÃ³n de Recetas',icon:'ğŸ•´ï¸',hp:75,maxHp:75,
   lore:'Lleva dÃ©cadas comprando y ocultando recetas Ãºnicas. Tiene el 90% del patrimonio gastronÃ³mico mundial bajo llave.',
   attacks:[{name:'Compra Forzada',emoji:'ğŸ’¼',desc:'Bloquea tus powerups',id:'doubleRules'},{name:'Contrato Ilegal',emoji:'ğŸ“‘',desc:'Congela tablero entero',id:'freezeAll'},{name:'ColecciÃ³n Robada',emoji:'ğŸ–¼ï¸',desc:'Elimina 2 tipos de tile',id:'eraseTwo'},{name:'El Archivo Secreto',emoji:'ğŸ—„ï¸',desc:'Invierte y corrompe',id:'invertAndCurse'},{name:'LO DEVORO TODO',emoji:'ğŸ‘¹',desc:'Destruye 14 ingredientes',id:'theFracture'}],
   winLore:'Imposible. Sus abogados llegan media hora despuÃ©s. Pero el cuaderno ya estÃ¡ a salvo.'},
  {id:20,level:600,name:'EL PASTEL INFINITO',title:'La Receta que lo Contiene Todo',icon:'ğŸŒŸ',hp:80,maxHp:80,
   lore:'No es un rival. Es la destilaciÃ³n de todo lo que aprendiste. El reto final es contra la mejor versiÃ³n de ti misma.',
   attacks:[{name:'Eco del Pasado',emoji:'ğŸ“–',desc:'Revive efectos anteriores',id:'randomEffect'},{name:'La Duda',emoji:'â“',desc:'Congela y degrada todo',id:'freezeAndDegrade'},{name:'PerfecciÃ³n Inalcanzable',emoji:'âœ¨',desc:'Aumenta objetivo un 80%',id:'rewriteObj'},{name:'El Tiempo',emoji:'â³',desc:'Quita 8 turnos',id:'timePenalty8'},{name:'EL PASTEL INFINITO',emoji:'ğŸŒˆ',desc:'Destruye 15 ingredientes',id:'theFracture'}],
   winLore:'Lo entiendes ahora. Solo tu reflejo en el horno apagado. Y el cuaderno, completo, brillando con todos los colores.'},
  {id:21,level:630,name:'ZEYNEP LA DEL CAMINO',title:'Guardiana de las Recetas Khan',icon:'ğŸª',hp:38,maxHp:38,
   lore:'Lleva cuarenta aÃ±os en la Ruta de la Seda preparando los mejores dulces de mantequilla de la regiÃ³n.',
   attacks:[{name:'Arena del Desierto',emoji:'ğŸœï¸',desc:'Congela una fila',id:'freezeRow'},{name:'Secreto del Khan',emoji:'ğŸ“œ',desc:'Invierte y degrada',id:'invertBoard'},{name:'Ruta Bloqueada',emoji:'ğŸš§',desc:'Fondant a 4 ingredientes',id:'addShields'},{name:'El Pergamino',emoji:'ğŸŒ€',desc:'Mezcla el tablero',id:'degradeShuffle'},{name:'Prueba Final',emoji:'âš”ï¸',desc:'Destruye 8 ingredientes',id:'theFracture'}],
   winLore:'Las recetas del Khan son tuyas. Las ganaste. Te entrega el pergamino original. Huele a especias que no existen ya.'},
  {id:22,level:660,name:'AMARA LA MATRIARCA',title:'La Abuela de Ãfrica',icon:'ğŸŒº',hp:42,maxHp:42,
   lore:'Setenta aÃ±os preparando injera dulce para bodas y funerales. Dice que la escala destruye el sabor.',
   attacks:[{name:'SabidurÃ­a Antigua',emoji:'ğŸŒ¿',desc:'Degrada todos los bÃ¡sicos',id:'allDegrade'},{name:'Fiesta Comunal',emoji:'ğŸ‰',desc:'Doble ataque',id:'doubleAttack'},{name:'Lluvia del Sahara',emoji:'ğŸ’§',desc:'Congela 2 filas',id:'freezeTwoRows'},{name:'Ubuntu',emoji:'ğŸ¤',desc:'Aumenta objetivo',id:'rewriteObj'},{name:'El FestÃ­n',emoji:'ğŸ–',desc:'Destruye 9 ingredientes',id:'theFracture'}],
   winLore:'Se rÃ­e tan fuerte que tres vecinas vienen a ver quÃ© pasa. Tienes razÃ³n Y estÃ¡s equivocada. Lo mÃ¡s interesante que me ha pasado en veinte aÃ±os.'},
  {id:23,level:690,name:'MARCO STERN',title:'El CrÃ­tico de Arte Comestible',icon:'ğŸ¨',hp:46,maxHp:46,
   lore:'Veinte aÃ±os destruyendo artistas emergentes con una frase. Ahora estÃ¡ frente a tu instalaciÃ³n con el bolÃ­grafo rojo.',
   attacks:[{name:'AnÃ¡lisis FrÃ­o',emoji:'ğŸ”',desc:'Elimina un tipo de tile',id:'eraseTier'},{name:'DeconstrucciÃ³n',emoji:'âœ‚ï¸',desc:'Invierte los tiers',id:'invertBoard'},{name:'CrÃ­tica Destructiva',emoji:'ğŸ“',desc:'Degrada fila y columna',id:'hiveMind'},{name:'Arte Irrelevante',emoji:'ğŸ–¼ï¸',desc:'Absorbe el combo',id:'comboAbsorb'},{name:'El BolÃ­grafo Rojo',emoji:'ğŸ–Šï¸',desc:'Destruye 10 ingredientes',id:'supremeAttack'}],
   winLore:'Interesante pero... irrelevante es lo que NO es esto. Cierra el bolÃ­grafo. Primera vez en veinte aÃ±os.'},
  {id:24,level:720,name:'INGRID LA VIKINGA',title:'La Reina del Kanelbullar',icon:'â„ï¸',hp:50,maxHp:50,
   lore:'Treinta aÃ±os haciendo los mejores kanelbullar del mundo en un pueblo de doscientas personas.',
   attacks:[{name:'Ventisca NÃ³rdica',emoji:'ğŸŒ¨ï¸',desc:'Congela todo el tablero',id:'freezeAll'},{name:'Mantequilla Helada',emoji:'ğŸ§ˆ',desc:'Degrada 2 filas',id:'shockwave'},{name:'Hygge Roto',emoji:'ğŸ’”',desc:'Corrompe 3 ingredientes',id:'curseThree'},{name:'El Invierno',emoji:'â˜ƒï¸',desc:'Quita 4 turnos',id:'timePenalty3'},{name:'Fuerza Vikinga',emoji:'âš¡',desc:'Destruye 11 ingredientes',id:'theFracture'}],
   winLore:'TenÃ­as razÃ³n en querer crecer. Y yo tenÃ­a razÃ³n en quedarme. Ambas cosas son verdad al mismo tiempo. Brinda con cafÃ© de cardamomo.'},
  {id:25,level:750,name:'CONCETTA LA NONNA',title:'La Guardiana de la Ricotta',icon:'ğŸ•',hp:55,maxHp:55,
   lore:'Noventa y dos aÃ±os, doce nietos, la mejor ricotta del mundo. Setenta aÃ±os haciendo la misma sfogliatella.',
   attacks:[{name:'Nonno Dijo',emoji:'ğŸ‘´',desc:'Invierte y mezcla',id:'invertShuffle'},{name:'Segreto di Famiglia',emoji:'ğŸ¤«',desc:'Fondant a 5 ingredientes',id:'addShields'},{name:'La Ricotta Perfecta',emoji:'ğŸ¥›',desc:'Elimina el tipo mÃ¡s frecuente',id:'eraseTier'},{name:'Mama Mia',emoji:'ğŸ˜¤',desc:'Degrada 2 filas y columna',id:'hiveMind'},{name:'Il Finale',emoji:'ğŸ',desc:'Destruye 11 ingredientes',id:'theFracture'}],
   winLore:'Perfetto. Una sola palabra. A sus noventa y dos aÃ±os, con setenta de experiencia. Perfetto equivale a una ovaciÃ³n de pie.'},
  {id:26,level:780,name:'EL RIVAL DE LAS NACIONES',title:'La TradiciÃ³n de 90 PaÃ­ses',icon:'ğŸŒ',hp:60,maxHp:60,
   lore:'No es una persona. Es el peso de noventa paÃ­ses con siglos de tradiciÃ³n gastronÃ³mica mirando cada movimiento.',
   attacks:[{name:'PresiÃ³n Mundial',emoji:'ğŸŒ',desc:'Aumenta objetivo 60%',id:'rewriteObj'},{name:'TradiciÃ³n Milenaria',emoji:'ğŸ“œ',desc:'Invierte y congela',id:'invertAndFreeze'},{name:'Las Naciones Unidas',emoji:'ğŸ¤',desc:'Doble ataque mÃºltiple',id:'doubleAttack'},{name:'El Protocolo',emoji:'âš ï¸',desc:'Elimina 2 tipos',id:'eraseTwo'},{name:'El Peso del Mundo',emoji:'ğŸŒŒ',desc:'Destruye 12 ingredientes',id:'theFracture'}],
   winLore:'El pabellÃ³n mÃ¡s visitado de la ExposiciÃ³n es el tuyo. El comitÃ© anuncia el Premio de la Humanidad. Las noventa naciones aplauden.'},
  {id:27,level:810,name:'WAN LA GUARDIANA',title:'Protectora de Recetas Sagradas',icon:'ğŸ›•',hp:65,maxHp:65,
   lore:'Cincuenta aÃ±os protegiendo las recetas sagradas del templo. Desconfiada por naturaleza y principio.',
   attacks:[{name:'Silencio del Templo',emoji:'ğŸ”‡',desc:'Bloquea todos los poderes',id:'doubleRules'},{name:'MeditaciÃ³n Profunda',emoji:'ğŸ§˜',desc:'Revierte el tablero',id:'timeRevert'},{name:'Guardiana Eterna',emoji:'ğŸ›¡ï¸',desc:'Fondant a 5 ingredientes',id:'addShields'},{name:'La Prueba del Fuego',emoji:'ğŸ”¥',desc:'Corrompe 4 ingredientes',id:'curseThree'},{name:'El Templo Decide',emoji:'âš¡',desc:'Destruye 13 ingredientes',id:'theFracture'}],
   winLore:'Las recetas sagradas no se dan. Se reconocen en quien ya las lleva dentro. TÃº las llevas desde hace tiempo.'},
  {id:28,level:840,name:'DR. NAKASHIMA',title:'El Ingeniero del Cero Gravedad',icon:'ğŸš€',hp:70,maxHp:70,
   lore:'Diez aÃ±os estudiando fluidos en microgravedad. Dice que la reposterÃ­a en el espacio es fÃ­sicamente imposible de hacer bien.',
   attacks:[{name:'Ley de Newton',emoji:'âš—ï¸',desc:'Invierte la gravedad del tablero',id:'invertBoard'},{name:'VacÃ­o CuÃ¡ntico',emoji:'ğŸŒŒ',desc:'Elimina 2 tipos de tile',id:'eraseTwo'},{name:'RadiaciÃ³n CÃ³smica',emoji:'â˜¢ï¸',desc:'Corrompe fila y columna',id:'hiveMind'},{name:'EcuaciÃ³n Imposible',emoji:'ğŸ“',desc:'Aumenta objetivo 70%',id:'rewriteObj'},{name:'Impacto Asteroide',emoji:'ğŸ’¥',desc:'Destruye 13 ingredientes',id:'theFracture'}],
   winLore:'La fÃ­sica dice que esto no puede funcionar. Pausa larga mirando el pastel en Ã³rbita. La fÃ­sica estaba equivocada.'},
  {id:29,level:870,name:'EL JUEZ DE LOS JUECES',title:'El Incorruptible',icon:'âš–ï¸',hp:75,maxHp:75,
   lore:'Cuarenta aÃ±os en el tribunal, nunca ha votado a favor de nadie. Cree que todo lo hecho por manos humanas contiene al menos un defecto.',
   attacks:[{name:'El Protocolo Supremo',emoji:'ğŸ“‹',desc:'Congela y degrada todo',id:'freezeAndDegrade'},{name:'Jurisprudencia',emoji:'âš–ï¸',desc:'Elimina 3 tipos de tile',id:'eraseThree'},{name:'Imparcialidad Absoluta',emoji:'ğŸ¤',desc:'Revierte el tablero',id:'timeRevert'},{name:'El Archivo',emoji:'ğŸ—„ï¸',desc:'Absorbe combo y quita turnos',id:'comboAbsorb'},{name:'La Sentencia Final',emoji:'ğŸ”¨',desc:'Destruye 14 ingredientes',id:'theFracture'}],
   winLore:'Un defecto en lo hecho con amor no es un fallo. Es una firma. Lo dice en voz alta por primera vez en cuarenta aÃ±os. Vota a favor.'},
  {id:30,level:900,name:'EL PASTEL ETERNO',title:'La Receta Sin Nombre',icon:'ğŸŒŒ',hp:90,maxHp:90,
   lore:'No es un rival. Es el tiempo, el amor, y todos los ingredientes que recogiste durante novecientos niveles.',
   attacks:[{name:'El Origen',emoji:'ğŸ“–',desc:'Revive todos los efectos',id:'randomEffect'},{name:'El Tiempo Total',emoji:'â³',desc:'Quita 10 turnos',id:'timePenalty8'},{name:'El Olvido',emoji:'ğŸŒ«ï¸',desc:'Elimina 4 tipos de tile',id:'eraseThree'},{name:'La Duda Final',emoji:'â“',desc:'Congela y degrada todo',id:'freezeAndDegrade'},{name:'EL PASTEL ETERNO',emoji:'ğŸŒŒ',desc:'Destruye 15 ingredientes',id:'theFracture'}],
   winLore:'No hay nadie enfrente. Solo el horno de RosalÃ­a, encendido por Ãºltima vez. El cuaderno estÃ¡ completo. Eres la receta mÃ¡s importante que RosalÃ­a dejÃ³ al mundo.'}
];

// â”€â”€â”€ SAVE STATE â”€â”€â”€
let G={
  coins:0,gems:100,unlocked:1,
  powerups:{rodillo:2,batidora:1,levadura:1,extra:2},
  bestScores:{},starsEarned:{},
  totalMerges:0,totalScore:0,bestCombo:0,
  streak:0,lastLogin:'',storiesSeen:{},rivalKills:0,
  currentChapter:1,
};
function saveG(){try{localStorage.setItem('swm_v1',JSON.stringify(G))}catch(e){}}
function loadG(){try{const d=JSON.parse(localStorage.getItem('swm_v1')||'null');if(d)Object.assign(G,d)}catch(e){}}

// â”€â”€â”€ GAME STATE â”€â”€â”€
let GM={
  level:1,score:0,moves:30,maxMoves:30,
  grid:[],rows:5,cols:5,
  selected:null,objective:null,objProgress:0,
  combo:0,levelDef:null,activePu:null,
  isRival:false,rival:null,rivalHp:0,rivalMaxHp:0,
  rivalAttackIn:3,comboAbsorbed:false,
};

// â”€â”€â”€ OBJECTIVE TYPES â”€â”€â”€
const OBJ_TYPES=['score','reach','collect','chain','score','reach'];

function buildLvlDef(num){
  const chap=CHAPTERS.find(c=>num>=c.levels[0]&&num<=c.levels[1])||CHAPTERS[0];
  const isRival=RIVALS.some(r=>r.level===num);
  const rival=isRival?RIVALS.find(r=>r.level===num):null;
  // Caps: maxTier increases slowly so early levels only have basic ingredients
  const maxTier=Math.min(Math.floor(num/10)+2,26);
  // Moves: start at 22, reduce slowly, never below 12. Rivals get +5 bonus.
  const movesBase=Math.max(12,22-Math.floor(num/15));
  const moves=isRival?movesBase+5:movesBase;
  // Special tiles unlock gradually
  const specials=['frozen','catalyst','bombt','shield','cursed','mirror'];
  const numSpecials=Math.min(Math.floor(num/35)+1,specials.length);
  const availSpecials=specials.slice(0,numSpecials);
  // Special tile rate increases slightly with level but stays low
  const specialRate=Math.min(0.07+Math.floor(num/80)*0.02, 0.15);

  let objective;
  if(isRival){
    objective={type:'rival',target:rival.hp,text:`Â¡Derrota a ${rival.name}!`,rivalId:rival.id};
  } else {
    const ot=OBJ_TYPES[(num-1)%OBJ_TYPES.length];
    if(ot==='score'){
      // Target = ~55% of what you'd score making a merge every turn at average tier
      const avgPts=(num+1)*100;
      const target=Math.floor(avgPts*moves*0.55);
      objective={type:'score',target:target,text:`Consigue ${target.toLocaleString()} puntos`};
    } else if(ot==='reach'){
      // Reach a tier that requires 2-3 merges to get there (not trivial)
      const t=Math.min(Math.floor(num/7)+2,maxTier,24);
      objective={type:'reach',target:t,text:`Crea ${ING[t].e} ${ING[t].n}`};
    } else if(ot==='collect'){
      const t=Math.min(Math.floor(num/10)+1,Math.floor(maxTier*0.55),18);
      const c=Math.min(1+Math.floor(num/60),3);
      objective={type:'collect',tier:t,target:c,text:`Crea Ã—${c} ${ING[t].e} ${ING[t].n}`};
    } else if(ot==='chain'){
      // Require a slightly longer chain
      const t=2+Math.floor(num/40);
      objective={type:'chain',target:t,text:`Â¡Combo de ${t} fusiones seguidas!`};
    } else {
      const avgPts=(num+1)*90;
      const target=Math.floor(avgPts*moves*0.52);
      objective={type:'score',target:target,text:`Consigue ${target.toLocaleString()} puntos`};
    }
  }
  return{num,chap,isRival,rival,maxTier,moves,availSpecials,specialRate,objective};
}

// â”€â”€â”€ GRID â”€â”€â”€
function buildGrid(def){
  const{rows,cols}=GM,grid=[];
  for(let r=0;r<rows;r++){grid[r]=[];for(let c=0;c<cols;c++)grid[r][c]=randTile(def);}
  // Guarantee 4-5 valid adjacent pairs so there are always some moves but not trivially many
  const pairs=4+Math.floor(Math.random()*2);
  for(let k=0;k<pairs;k++){
    const r=Math.floor(Math.random()*(rows-1)),c=Math.floor(Math.random()*(cols-1));
    const base={...grid[r][c],special:null,frozen:false,catalyst:false,bombt:false,shield:false,cursed:false,mirror:false};
    if(Math.random()<.5&&c+1<cols) grid[r][c+1]=base;
    else grid[r+1][c]=base;
  }
  return grid;
}

function randTile(def){
  // Weighted: favor lower tiers so matches are common and manageable
  const maxT=def.maxTier;
  // Most tiles will be tiers 0..floor(maxT*0.5), some higher
  const roll=Math.random();
  let tier;
  if(roll<0.55) tier=Math.floor(Math.random()*Math.max(1,Math.floor(maxT*0.35)+1));
  else if(roll<0.85) tier=Math.floor(Math.random()*Math.max(1,Math.floor(maxT*0.65)+1));
  else tier=Math.floor(Math.random()*(maxT+1));
  tier=Math.min(tier,maxT);
  const doSpecial=def.availSpecials.length&&Math.random()<def.specialRate;
  const sType=doSpecial?def.availSpecials[Math.floor(Math.random()*def.availSpecials.length)]:null;
  return{tier,special:sType,frozen:sType==='frozen',catalyst:sType==='catalyst',bombt:sType==='bombt',shield:sType==='shield',cursed:sType==='cursed',mirror:sType==='mirror'};
}

// â”€â”€â”€ RENDER â”€â”€â”€
function renderGrid(){
  const el=document.getElementById('grid');
  const{rows,cols}=GM;
  const vw=window.innerWidth,vh=window.innerHeight;
  const hudH=GM.isRival?155:118;const botH=76;
  const avail=Math.min(vw*.92,420,(vh-hudH-botH));
  const cell=Math.max(42,Math.floor((avail-cols*5-20)/cols));
  el.style.gridTemplateColumns=`repeat(${cols},${cell}px)`;
  el.innerHTML='';
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const t=GM.grid[r]?.[c];
    if(!t){const d=document.createElement('div');d.style.cssText=`width:${cell}px;height:${cell}px`;el.appendChild(d);continue;}
    const ing=ING[Math.min(t.tier,ING.length-1)];
    const d=document.createElement('div');
    d.className='tile'+(t.frozen?' frozen':'')+(t.catalyst?' catalyst':'')+(t.bombt?' bombt':'')+(t.shield?' shield':'')+(t.cursed?' cursed':'')+(t.mirror?' mirror':'');
    d.style.cssText=`width:${cell}px;height:${cell}px;background:linear-gradient(135deg,${ing.c}22,${ing.c}44);border-color:${ing.c}66;box-shadow:0 3px ${cell*.22}px ${ing.g},inset 0 1px 0 rgba(255,255,255,.5);`;
    if(GM.selected?.r===r&&GM.selected?.c===c){d.classList.add('sel');d.style.boxShadow=`0 0 ${cell*.45}px ${ing.g},0 0 0 2.5px ${ing.c},inset 0 1px 0 rgba(255,255,255,.6)`;}
    const fSize=Math.max(16,Math.round(cell*.38));
    const nSize=Math.max(5.5,Math.round(cell*.12));
    d.innerHTML=`<div class="tile-shine"></div><div class="tile-em" style="font-size:${fSize}px">${ing.e}</div><div class="tile-nm" style="color:${ing.c};font-size:${nSize}px">${ing.n}</div>`;
    d.addEventListener('touchstart',ev=>{ev.preventDefault();tapTile(r,c);},{passive:false});
    d.addEventListener('click',()=>tapTile(r,c));
    el.appendChild(d);
  }
}

// â”€â”€â”€ TAP â”€â”€â”€
function tapTile(r,c){
  if(GM.moves<=0)return;
  const tile=GM.grid[r]?.[c];if(!tile)return;
  if(GM.activePu){applyPu(GM.activePu,r,c);return;}
  if(!GM.selected){GM.selected={r,c};renderGrid();sfxT();return;}
  if(GM.selected.r===r&&GM.selected.c===c){GM.selected=null;renderGrid();return;}
  const{r:sr,c:sc}=GM.selected;
  if(Math.abs(r-sr)+Math.abs(c-sc)!==1){GM.selected={r,c};renderGrid();return;}
  const sel=GM.grid[sr][sc];
  if(sel.tier===tile.tier&&!tile.frozen&&!sel.frozen&&!tile.shield&&!sel.shield){
    doMerge(sr,sc,r,c);
  } else {
    if(sel.shield){sel.shield=false;GM.combo=0;showNotif('ğŸ‚ Â¡Fondant roto! Combo perdido.');GM.selected=null;GM.moves--;updateHUD();renderGrid();}
    else{GM.selected={r,c};renderGrid();}
  }
}

// â”€â”€â”€ MERGE â”€â”€â”€
function doMerge(r1,c1,r2,c2){
  const t1=GM.grid[r1][c1],t2=GM.grid[r2][c2];
  const catalyst=t1.catalyst||t2.catalyst;
  const mirror=t1.mirror||t2.mirror;
  let newTier=Math.min(t1.tier+1+(catalyst?1:0),ING.length-1);
  const ing=ING[newTier];
  const comboMult=GM.comboAbsorbed?1:Math.max(1,1+(GM.combo-1)*0.3);
  const mirrorMult=mirror?2:1;
  const pts=Math.max(50,(newTier+1)*120)*comboMult*mirrorMult|0;
  GM.score+=pts;GM.combo++;G.totalMerges++;
  if(GM.comboAbsorbed)GM.comboAbsorbed=false;
  if(GM.combo>G.bestCombo)G.bestCombo=GM.combo;
  G.totalScore+=pts;

  // Particle pos
  const gEl=document.getElementById('grid');
  const rc=gEl.getBoundingClientRect();
  const cellsz=gEl.querySelector('.tile')?.offsetWidth||50;
  const px=rc.left+c2*(cellsz+5)+10+cellsz/2;
  const py=rc.top+r2*(cellsz+5)+10+cellsz/2;
  spawnPt(px,py,ing.c,16);spawnPt(px,py,'#fff',4);

  // Bomb
  if(t2.bombt||t1.bombt){
    [[r2-1,c2],[r2+1,c2],[r2,c2-1],[r2,c2+1]].forEach(([nr,nc])=>{
      if(GM.grid[nr]?.[nc]&&!GM.grid[nr][nc].shield){spawnPt(px,py,ING[GM.grid[nr][nc].tier].c,6);GM.grid[nr][nc]=randTile(GM.levelDef);GM.score+=400;}
    });
    showNotif('ğŸ’£ Â¡SoufflÃ© Explosivo! +400');
  }
  // Cursed
  if(t2.cursed||t1.cursed){GM.moves=Math.max(1,GM.moves-2);showNotif('ğŸ”¥ Â¡Ingrediente quemado! âˆ’2 turnos');}

  GM.grid[r2][c2]={tier:newTier,special:null,frozen:false,catalyst:false,bombt:false,shield:false,cursed:false,mirror:false};
  GM.grid[r1][c1]=randTile(GM.levelDef);
  GM.selected=null;

  sfxMerge(newTier);if(newTier>=14)sfxBig();
  showMergePopup(px,py,ing,pts);
  updateHUD();renderGrid();

  // Rival damage then progress
  if(GM.isRival&&GM.rival){
    const dmg=Math.max(1,1+Math.floor(newTier/5));
    GM.rivalHp=Math.max(0,GM.rivalHp-dmg);
    updateRivalHp();
    updateObjProgress(newTier);
    if(GM.rivalHp<=0){setTimeout(rivalWin,400);return;}
  } else {
    updateObjProgress(newTier);
  }
  checkObj();
}

// â”€â”€â”€ OBJECTIVE â”€â”€â”€
function updateObjProgress(tier){
  const o=GM.objective;
  if(o.type==='score')GM.objProgress=GM.score;
  else if(o.type==='reach'){if(tier>=o.target)GM.objProgress=1;}
  else if(o.type==='collect'){if(tier===o.tier)GM.objProgress++;}
  else if(o.type==='chain')GM.objProgress=Math.max(GM.objProgress,GM.combo);
  else if(o.type==='rival')GM.objProgress=GM.rivalMaxHp-GM.rivalHp;
  const pct=Math.min(GM.objProgress/(o.target||1),1);
  const fill=document.getElementById('objFill');if(fill)fill.style.width=(pct*100)+'%';
  document.getElementById('objPrg').textContent=
    `${Math.min(GM.objProgress,o.target).toLocaleString()}/${o.target.toLocaleString()}`;
}

function checkObj(){
  const o=GM.objective;
  let met=false;
  if(o.type==='score')met=GM.score>=o.target;
  else if(o.type==='reach')met=GM.objProgress>=1;
  else if(o.type==='collect')met=GM.objProgress>=o.target;
  else if(o.type==='chain')met=GM.objProgress>=o.target;
  if(met&&!GM.isRival){setTimeout(levelWin,350);return;}
  GM.moves--;updateHUD();
  if(GM.moves<=0)setTimeout(triggerLose,350);
  else if(GM.isRival&&GM.rival)rivalAttackTick();
}

// â”€â”€â”€ RIVAL ATTACKS â”€â”€â”€
function rivalAttackTick(){
  GM.rivalAttackIn--;
  if(GM.rivalAttackIn<=0){
    GM.rivalAttackIn=2+Math.floor(Math.random()*2);
    executeRivalAttack();
  }
}

function executeRivalAttack(){
  if(!GM.rival)return;
  const atk=GM.rival.attacks[Math.floor(Math.random()*GM.rival.attacks.length)];
  showNotif(`ğŸ‘¨â€ğŸ³ ${GM.rival.name}: ${atk.emoji} ${atk.name}!`);
  flashRivalAttack();
  const{rows,cols}=GM;

  switch(atk.id){
    case 'freezeRow':{const r=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r][c])GM.grid[r][c].frozen=true;}break;}
    case 'timePenalty':{GM.moves=Math.max(1,GM.moves-2);showNotif('âš ï¸ âˆ’2 turnos de multa!');break;}
    case 'timePenalty3':{GM.moves=Math.max(1,GM.moves-3);showNotif('â° âˆ’3 turnos!');break;}
    case 'timePenalty5':{GM.moves=Math.max(1,GM.moves-5);showNotif('â° âˆ’5 turnos!');break;}
    case 'invertBoard':{GM.grid.flat().forEach(t=>{if(t)t.tier=Math.max(0,GM.levelDef.maxTier-t.tier);});break;}
    case 'addShields':{let n=0;while(n<3){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c].shield=true;n++;}}break;}
    case 'curseTwo':{let n=0;while(n<2){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].cursed){GM.grid[r][c].cursed=true;n++;}}break;}
    case 'curseThree':{let n=0;while(n<3){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].cursed){GM.grid[r][c].cursed=true;n++;}}break;}
    case 'curseRow':{const r=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r][c])GM.grid[r][c].cursed=true;}break;}
    case 'witherTwo':{let n=0;while(n<2){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&GM.grid[r][c].tier>0){GM.grid[r][c].tier--;n++;}}break;}
    case 'poisonCol':{const col=Math.floor(Math.random()*cols);for(let r=0;r<rows;r++){if(GM.grid[r][col])GM.grid[r][col].cursed=true;}break;}
    case 'consumeMax':{let maxT=-1,mr=-1,mc=-1;GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&t.tier>maxT&&!t.shield){maxT=t.tier;mr=r;mc=c;}}));if(mr>=0)GM.grid[mr][mc]=randTile(GM.levelDef);break;}
    case 'crossDestroy':{const r=Math.floor(rows/2),c=Math.floor(cols/2);[[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr,nc])=>{if(GM.grid[nr]?.[nc]&&!GM.grid[nr][nc].shield)GM.grid[nr][nc]=randTile(GM.levelDef);});break;}
    case 'degradeShuffle':{const flat=GM.grid.flat().sort(()=>Math.random()-.5);flat.forEach(t=>{if(t&&t.tier>0&&Math.random()<.35)t.tier--;});let i=0;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)GM.grid[r][c]=flat[i++]||randTile(GM.levelDef);break;}
    case 'massBasic':{GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&Math.random()<.4)GM.grid[r][c]={...randTile(GM.levelDef),tier:Math.floor(Math.random()*2)};}));break;}
    case 'doubleAttack':{setTimeout(()=>{if(GM.rival)executeRivalAttack();},500);break;}
    case 'sporeFrost':{const r=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r][c]){if(c%2===0)GM.grid[r][c].frozen=true;else GM.grid[r][c].tier=Math.max(0,GM.grid[r][c].tier-1);}}break;}
    case 'paradox':{GM.grid.flat().forEach(t=>{if(t&&Math.random()<.55)t.tier=Math.floor(Math.random()*(GM.levelDef.maxTier+1));});break;}
    case 'darkThought':{[[0,0],[0,cols-1],[rows-1,0],[rows-1,cols-1]].forEach(([r,c])=>{if(GM.grid[r]?.[c])GM.grid[r][c].frozen=true;});break;}
    case 'comboAbsorb':{GM.comboAbsorbed=true;showNotif('ğŸ§² Â¡PrÃ³xima fusiÃ³n sin bonus de combo!');break;}
    case 'shockwave':{const r=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r][c]&&GM.grid[r][c].tier>0)GM.grid[r][c].tier--;}break;}
    case 'finalNova':{let n=0;while(n<5){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
    case 'rewriteObj':{if(GM.objective.type==='score'){GM.objective.target=Math.round(GM.objective.target*1.25);showNotif('âœï¸ Â¡Objetivo aumentado!');}break;}
    case 'freezeAndDegrade':{const r=Math.floor(Math.random()*rows);const r2=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r]?.[c])GM.grid[r][c].frozen=true;if(GM.grid[r2]?.[c]&&GM.grid[r2][c].tier>0)GM.grid[r2][c].tier--;}break;}
    case 'hiveMind':{const mr=Math.floor(Math.random()*rows),mc=Math.floor(Math.random()*cols);for(let c=0;c<cols;c++){if(GM.grid[mr]?.[c]&&!GM.grid[mr][c].shield&&GM.grid[mr][c].tier>0)GM.grid[mr][c].tier--;}for(let r=0;r<rows;r++){if(GM.grid[r]?.[mc]&&!GM.grid[r][mc].shield&&GM.grid[r][mc].tier>0)GM.grid[r][mc].tier--;}break;}
    case 'eraseTier':{const target=Math.floor(Math.random()*(Math.min(GM.levelDef.maxTier,8)+1));GM.grid.forEach((row,r)=>row.forEach((t,c)=>{if(t&&t.tier===target)GM.grid[r][c]=randTile(GM.levelDef);}));showNotif(`ğŸ—‘ï¸ Â¡${ING[target].e} eliminados del tablero!`);break;}
    case 'timeRevert':{GM.grid=buildGrid(GM.levelDef);showNotif('â†©ï¸ Â¡El tablero regresa!');break;}
    case 'doubleRules':{showNotif('ğŸ“„ Â¡Poderes cuestan el doble!');break;}
    case 'freezeAndShield':{const r1r=Math.floor(Math.random()*rows),r2r=Math.floor(Math.random()*rows);for(let c=0;c<cols;c++){if(GM.grid[r1r]?.[c])GM.grid[r1r][c].frozen=true;if(GM.grid[r2r]?.[c])GM.grid[r2r][c].shield=true;}break;}
    case 'invertShuffle':{GM.grid.flat().forEach(t=>{if(t)t.tier=Math.max(0,GM.levelDef.maxTier-t.tier);});const flat=GM.grid.flat().sort(()=>Math.random()-.5);let i=0;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)GM.grid[r][c]=flat[i++]||randTile(GM.levelDef);break;}
    case 'summonMinion':{const minion=RIVALS[Math.floor(Math.random()*Math.min(GM.rival.id-1,RIVALS.length-1))];for(let i=0;i<2;i++){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c])GM.grid[r][c].shield=true;}showNotif(`ğŸ‘¤ Â¡Llama al espÃ­ritu de ${minion.name}!`);break;}
    case 'supremeAttack':{let n=0;while(n<10){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}showNotif('ğŸ° Â¡LA GRAN DEGUSTACIÃ“N! 10 ingredientes perdidos!');break;}
    case 'theFracture':{let n=0;while(n<8){const r=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols);if(GM.grid[r][c]&&!GM.grid[r][c].shield){GM.grid[r][c]=randTile(GM.levelDef);n++;}}break;}
  }
  renderGrid();updateHUD();
}

function flashRivalAttack(){
  const d=document.createElement('div');d.className='rival-attack-overlay';document.body.appendChild(d);setTimeout(()=>d.remove(),600);
}

function updateRivalHp(){
  const pct=GM.rivalHp/GM.rivalMaxHp;
  const fill=document.getElementById('rivalHpFill');if(fill)fill.style.width=(pct*100)+'%';
  document.getElementById('rivalHpVal').textContent=`${GM.rivalHp}/${GM.rivalMaxHp}`;
  const color=pct>.5?'linear-gradient(90deg,#7f1d1d,#ef4444,#fca5a5)':pct>.25?'linear-gradient(90deg,#92400e,#f59e0b)':'linear-gradient(90deg,#fbbf24,#fff)';
  if(fill)fill.style.background=color;
  updateObjProgress(0);
}

// â”€â”€â”€ HUD â”€â”€â”€
function updateHUD(){
  document.getElementById('hScore').textContent=GM.score.toLocaleString();
  document.getElementById('hMoves').textContent=GM.moves;
  document.getElementById('hLevel').textContent=GM.level;
  const pct=GM.moves/GM.maxMoves;
  document.getElementById('mvArc').style.strokeDashoffset=(125.7*(1-pct)).toFixed(1);
  const mvEl=document.getElementById('hMoves');
  mvEl.className='mv-txt'+(GM.moves<=5?' moves-low':'');
}

// â”€â”€â”€ POWERUPS â”€â”€â”€
const PU_KEYS={rodillo:'rodillo',batidora:'batidora',levadura:'levadura',extra:'extra'};
function selPu(type){
  if(G.powerups[type]<=0){showNotif('âŒ Sin este utensilio. Â¡Visita la tienda!');sfxFail();return;}
  if(GM.activePu===type){GM.activePu=null;document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));return;}
  GM.activePu=type;
  document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));
  const key='pu'+type.charAt(0).toUpperCase()+type.slice(1);
  document.getElementById(key)?.classList.add('act');
  const msgs={rodillo:'ğŸ‚ Toca para romper ingrediente',batidora:'ğŸ”€ Mezclando tablero...',levadura:'â¬†ï¸ Toca para subir tier',extra:'â° +5 turnos aÃ±adidos'};
  showNotif(msgs[type]);
  if(type==='batidora'||type==='extra')applyPu(type,-1,-1);
  else sfxPu();
}
function applyPu(type,r,c){
  G.powerups[type]--;GM.activePu=null;
  document.querySelectorAll('.pu').forEach(b=>b.classList.remove('act'));
  updatePuBar();sfxPu();
  if(type==='rodillo'&&r>=0){GM.grid[r][c]=randTile(GM.levelDef);showNotif('ğŸ‚ Â¡Ingrediente destruido!');}
  else if(type==='batidora'){const flat=GM.grid.flat().sort(()=>Math.random()-.5);let i=0;for(let rr=0;rr<GM.rows;rr++)for(let cc=0;cc<GM.cols;cc++)GM.grid[rr][cc]=flat[i++]||randTile(GM.levelDef);showNotif('ğŸ”€ Â¡Tablero mezclado!');}
  else if(type==='levadura'&&r>=0){const t=GM.grid[r][c];if(t){t.tier=Math.min(t.tier+1,ING.length-1);t.frozen=false;showNotif(`â¬†ï¸ Â¡${ING[t.tier].n} listo!`);}}
  else if(type==='extra'){GM.moves+=5;GM.maxMoves+=5;showNotif('â° Â¡+5 turnos!');}
  renderGrid();updateHUD();saveG();
}
function updatePuBar(){
  ['Rodillo','Batidora','Levadura','Extra'].forEach(k=>{
    const el=document.getElementById('pu'+k+'N');if(el)el.textContent=G.powerups[k.toLowerCase()]||0;
  });
}

// â”€â”€â”€ WIN / LOSE â”€â”€â”€
function levelWin(){
  sfxWin();
  const prev=G.bestScores[GM.level]||0;
  if(GM.score>prev)G.bestScores[GM.level]=GM.score;
  if(GM.level>=G.unlocked&&GM.level<900)G.unlocked=GM.level+1;
  const coinB=Math.floor(GM.score/200)+10;G.coins+=coinB;
  const moveRatio=GM.moves/GM.maxMoves;
  const stars=moveRatio>.5?3:moveRatio>.2?2:1;
  if(!G.starsEarned[GM.level]||stars>G.starsEarned[GM.level])G.starsEarned[GM.level]=stars;
  // Update chapter progress
  const chap=GM.levelDef.chap;
  G.currentChapter=Math.max(G.currentChapter,chap.id);
  saveG();sfxCoin();
  document.getElementById('resStars').textContent='â­'.repeat(stars)+'â˜†'.repeat(3-stars);
  document.getElementById('resScore').textContent=GM.score.toLocaleString()+' pts';
  document.getElementById('resBest').textContent=GM.score>prev?'ğŸ† Â¡NUEVO RÃ‰CORD!':'MEJOR: '+prev.toLocaleString();
  document.getElementById('resBonus').textContent=`+ğŸ’°${coinB} monedas`;
  showPanel('winPanel');
}

function rivalWin(){
  sfxWin();sfxWin();
  const rival=GM.rival;G.rivalKills++;
  if(GM.level>=G.unlocked&&GM.level<900)G.unlocked=GM.level+1;
  const coinB=80+Math.floor(GM.level/30)*40;const gemB=12+Math.floor(GM.level/30)*4;
  G.coins+=coinB;G.gems+=gemB;
  G.bestScores[GM.level]=GM.score;G.starsEarned[GM.level]=3;
  G.currentChapter=Math.max(G.currentChapter,GM.levelDef.chap.id);
  saveG();sfxCoin();sfxCoin();
  document.getElementById('rwTitle').textContent=`Â¡${rival.name} superado!`;
  document.getElementById('rwSub').textContent=rival.title.toUpperCase();
  document.getElementById('rwStars').textContent='â­â­â­';
  document.getElementById('rwScore').textContent=GM.score.toLocaleString()+' pts';
  document.getElementById('rwBonus').textContent=`+ğŸ’°${coinB} +ğŸ’${gemB}`;
  document.getElementById('rwLore').textContent=rival.winLore;
  showPanel('rivalWinPanel');
}

function triggerLose(){
  sfxFail();
  document.getElementById('goScore').textContent=GM.score.toLocaleString()+' pts';
  showPanel('losePanel');
}

// â”€â”€â”€ LEVEL FLOW â”€â”€â”€
function startLevel(num){
  hideAllPanels();
  GM.level=num;GM.score=0;GM.combo=0;GM.selected=null;GM.activePu=null;GM.comboAbsorbed=false;
  GM.levelDef=buildLvlDef(num);
  GM.isRival=GM.levelDef.isRival;GM.rival=GM.levelDef.rival||null;
  GM.objective=GM.levelDef.objective;GM.objProgress=0;
  GM.moves=GM.levelDef.moves;GM.maxMoves=GM.levelDef.moves;
  GM.rows=5;GM.cols=GM.levelDef.isRival?6:5;
  GM.grid=buildGrid(GM.levelDef);
  if(GM.isRival&&GM.rival){GM.rivalHp=GM.rival.hp;GM.rivalMaxHp=GM.rival.hp;GM.rivalAttackIn=3;}

  hideAllScreens();showScreen('gameScreen');

  const rBar=document.getElementById('rivalHpBar');
  if(GM.isRival&&GM.rival){
    rBar.style.display='block';
    document.getElementById('rivalHpName').textContent=`${GM.rival.icon} ${GM.rival.name}`;
    updateRivalHp();
  } else {rBar.style.display='none';}

  document.getElementById('objBanner').innerHTML=
    `<div class="obj-t">${GM.objective.text}</div>
     <div class="obj-p" id="objPrg">0/${GM.objective.target.toLocaleString()}</div>
     <div class="obj-prog-bar"><div class="obj-prog-fill" id="objFill" style="width:0%"></div></div>`;

  updateHUD();updatePuBar();renderGrid();
  if(GM.isRival)showNotif(`ğŸ‘¨â€ğŸ³ Â¡Reto de ${GM.rival?.name}!`);
}

function nextLvl(){
  hideAllPanels();
  const next=Math.min(GM.level+1,900);
  const story=ALL_STORIES[next-1];
  if(story&&!G.storiesSeen[next-1]){
    G.storiesSeen[next-1]=true;saveG();
    showStory(story,()=>checkRivalIntro(next));
  } else {
    checkRivalIntro(next);
  }
}
function checkRivalIntro(lvl){
  const rival=RIVALS.find(r=>r.level===lvl);
  if(rival&&!G.storiesSeen['rival_'+lvl]){
    G.storiesSeen['rival_'+lvl]=true;saveG();
    showRivalIntro(rival,()=>startLevel(lvl));
  } else startLevel(lvl);
}
function replayLvl(){hideAllPanels();startLevel(GM.level);}
function buyMoves(){if(G.gems>=20){G.gems-=20;GM.moves+=5;GM.maxMoves+=5;saveG();hidePanel('losePanel');updateHUD();showNotif('â° +5 turnos!');}else{showNotif('ğŸ’ Sin gemas suficientes.');sfxFail();}}
function watchAd(){showNotif('ğŸ“º Cargando anuncio...');setTimeout(()=>{GM.moves+=3;GM.maxMoves+=3;hidePanel('losePanel');updateHUD();showNotif('âœ… Â¡+3 turnos gratis!');},1600);}
function confirmQuit(){showPanel('quitPanel');}
function doQuit(){hideAllPanels();goChapters();}

// â”€â”€â”€ CHAPTER SELECT â”€â”€â”€
function goChapters(){
  hideAllPanels();hideAllScreens();showScreen('chapterScreen');
  const cont=document.getElementById('chapterCards');cont.innerHTML='';
  CHAPTERS.forEach(ch=>{
    const isLocked=G.unlocked<ch.levels[0];
    const progress=Object.keys(G.bestScores).filter(k=>+k>=ch.levels[0]&&+k<=ch.levels[1]).length;
    const total=ch.levels[1]-ch.levels[0]+1;
    const div=document.createElement('div');
    div.className='chap-card'+(isLocked?' locked':'');
    div.style.background=`linear-gradient(135deg,${ch.color},rgba(255,255,255,.8))`;
    div.innerHTML=`<div class="chap-icon">${ch.icon}</div>
      <div class="chap-info">
        <div class="chap-num">CAPÃTULO ${ch.id}</div>
        <div class="chap-name">${ch.name}</div>
        <div class="chap-desc">${ch.desc}</div>
        ${!isLocked?`<div class="chap-prog">${progress}/${total} recetas Â· Nv.${ch.levels[0]}â€“${ch.levels[1]}</div>`:''}
      </div>`;
    if(!isLocked)div.addEventListener('click',()=>goLevelSelect(ch));
    cont.appendChild(div);
  });
}

function goLevelSelect(chap){
  hideAllScreens();showScreen('levelScreen');
  document.getElementById('levelScreenTitle').textContent=`${chap.icon} ${chap.name}`;
  const grid=document.getElementById('lvlGrid');grid.innerHTML='';
  for(let i=chap.levels[0];i<=chap.levels[1];i++){
    const locked=i>G.unlocked;
    const completed=!!G.bestScores[i];
    const isRival=i===chap.rivalLevel;
    const btn=document.createElement('div');
    btn.className=`lvl-btn${locked?' locked':completed?' completed':' unlocked'}${isRival?' rival-lvl':''}`;
    const stars=G.starsEarned[i]||0;
    btn.innerHTML=`<div class="lvl-ico">${locked?'ğŸ”’':isRival?'âš”ï¸':ING[Math.min(Math.floor(i/10),ING.length-1)].e}</div>
      <div class="lvl-n">${isRival?'RETO':i}</div>
      <div class="lvl-stars">${completed?'â­'.repeat(stars)+'â˜†'.repeat(3-stars):''}</div>`;
    if(!locked)btn.addEventListener('click',()=>{
      const rival=RIVALS.find(r=>r.level===i);
      if(rival&&!G.storiesSeen['rival_'+i]){
        G.storiesSeen['rival_'+i]=true;saveG();
        showRivalIntro(rival,()=>startLevel(i));
      } else {
        const story=ALL_STORIES[i];
        if(story&&!G.storiesSeen[i]){G.storiesSeen[i]=true;saveG();showStory(story,()=>startLevel(i));}
        else startLevel(i);
      }
    });
    grid.appendChild(btn);
  }
}

// â”€â”€â”€ STORY / RIVAL INTRO â”€â”€â”€
let storyCB=null;
function showStory(data,cb){
  storyCB=cb||null;
  document.getElementById('stEpisode').textContent=data.ep||'HISTORIA';
  document.getElementById('stIcon').textContent=data.icon||'ğŸ ';
  document.getElementById('stTitle').textContent=data.title||'';
  document.getElementById('stText').textContent=data.text||'';
  document.getElementById('stQuote').textContent=data.quote||'';
  hideAllScreens();showScreen('storyScreen');
}
function dismissStory(){const cb=storyCB;storyCB=null;if(cb)cb();else goMenu();}

let rivalIntroCB=null;
function showRivalIntro(rival,cb){
  rivalIntroCB=cb||null;
  document.getElementById('riIcon').textContent=rival.icon;
  document.getElementById('riName').textContent=rival.name;
  document.getElementById('riTitle').textContent=rival.title;
  document.getElementById('riLore').textContent=rival.lore;
  const ab=document.getElementById('riAbilities');ab.innerHTML='';
  rival.attacks.forEach(a=>{
    const d=document.createElement('div');d.className='rival-ability';
    d.innerHTML=`<div class="ra-icon">${a.emoji}</div><div><div class="ra-text">${a.name}</div><div class="ra-desc">${a.desc}</div></div>`;
    ab.appendChild(d);
  });
  hideAllScreens();showScreen('rivalIntroScreen');
}
function dismissRivalIntro(){const cb=rivalIntroCB;rivalIntroCB=null;if(cb)cb();else goMenu();}

// â”€â”€â”€ SHOP â”€â”€â”€
const SHOP=[
  {section:'ğŸ’ GEMAS ESPECIALES',items:[
    {icon:'ğŸ’',name:'Bolsita',     desc:'50 gemas',        price:'$0.99',action:'g50'},
    {icon:'ğŸ’ğŸ’',name:'Tarrito',   desc:'200 gemas +BONUS',price:'$2.99',action:'g200',pop:true},
    {icon:'ğŸº',name:'Bote Grande', desc:'600 gemas +Ã‰PICO',price:'$9.99',action:'g600',feat:true},
    {icon:'ğŸŒŸ',name:'ColecciÃ³n',   desc:'2000 gemas +MEGA',price:'$24.99',action:'g2000'},
  ]},
  {section:'ğŸ’° MONEDAS DE MANTEQUILLA',items:[
    {icon:'ğŸ’°',name:'PuÃ±ado',      desc:'1.000 monedas',   price:'$0.99',action:'c1k'},
    {icon:'ğŸ’°',name:'Saquito',     desc:'5.000 monedas',   price:'$3.99',action:'c5k',pop:true},
    {icon:'ğŸ†',name:'Tesoro',      desc:'20.000 monedas',  price:'$9.99',action:'c20k',feat:true},
  ]},
  {section:'ğŸ´ UTENSILIOS DE COCINA',items:[
    {icon:'ğŸ‚',name:'Rodillo Ã—5',  desc:'Destruye 1 ingredient.',gems:30,action:'pr5'},
    {icon:'ğŸ”€',name:'Batidora Ã—3', desc:'Mezcla el tablero',    gems:25,action:'pb3'},
    {icon:'â¬†ï¸',name:'Levadura Ã—5', desc:'Sube 1 tier',          gems:35,action:'pl5',pop:true},
    {icon:'â°',name:'Tiempo Ã—3',   desc:'+5 turnos por uso',    gems:20,action:'pe3'},
  ]},
  {section:'ğŸ PAQUETES DULCES',items:[
    {icon:'ğŸ',name:'Pack Inicio', desc:'200ğŸ’+5kğŸ’°+utensilios',price:'$1.99',action:'starter',feat:true,pop:true},
    {icon:'ğŸ‘‘',name:'Chef Pass',   desc:'Recompensas diarias Ã©picas',price:'$4.99/mes',action:'season'},
    {icon:'â™¾ï¸',name:'Sin Anuncios',desc:'Experiencia pura',     price:'$2.99',action:'noads'},
    {icon:'ğŸŒŸ',name:'Pack VIP',    desc:'Todo incluido',        price:'$19.99',action:'vip',feat:true},
  ]},
];
function goShop(){
  hideAllPanels();hideAllScreens();showScreen('shopScreen');
  document.getElementById('sCoins').textContent=G.coins.toLocaleString();
  document.getElementById('sGems').textContent=G.gems;
  buildShop();
}
function buildShop(){
  const sc=document.getElementById('shopContent');sc.innerHTML='';
  SHOP.forEach(sec=>{
    const s=document.createElement('div');s.className='shop-sec';
    s.innerHTML=`<div class="shop-sec-title">${sec.section}</div>`;
    const row=document.createElement('div');row.className='shop-row';
    sec.items.forEach(item=>{
      const d=document.createElement('div');
      d.className='shop-card'+(item.feat?' feat':'')+(item.pop?' pop':'');
      d.innerHTML=`<div class="sc-icon">${item.icon}</div><div class="sc-name">${item.name}</div><div class="sc-desc">${item.desc}</div><div class="sc-price">${item.price||(item.gems?'ğŸ’'+item.gems:'')}</div>`;
      d.onclick=()=>handleBuy(item);row.appendChild(d);
    });
    s.appendChild(row);sc.appendChild(s);
  });
}
function handleBuy(item){
  if(item.gems){
    if(G.gems<item.gems){showNotif('ğŸ’ Sin gemas. Â¡Visita la tienda!');sfxFail();return;}
    G.gems-=item.gems;
    if(item.action==='pr5')G.powerups.rodillo+=5;
    else if(item.action==='pb3')G.powerups.batidora+=3;
    else if(item.action==='pl5')G.powerups.levadura+=5;
    else if(item.action==='pe3')G.powerups.extra+=3;
    showNotif(`âœ… Â¡${item.name} aÃ±adido!`);sfxCoin();saveG();buildShop();
    document.getElementById('sGems').textContent=G.gems;return;
  }
  showNotif('ğŸ§ Procesando pedido...');
  setTimeout(()=>{
    const acts={
      g50:()=>G.gems+=50,g200:()=>G.gems+=200,g600:()=>G.gems+=600,g2000:()=>G.gems+=2000,
      c1k:()=>G.coins+=1000,c5k:()=>G.coins+=5500,c20k:()=>G.coins+=25000,
      starter:()=>{G.gems+=200;G.coins+=5000;G.powerups.rodillo+=3;G.powerups.levadura+=3;G.powerups.batidora+=2;},
      season:()=>showNotif('ğŸ‘‘ Chef Pass activado!'),
      noads:()=>showNotif('â™¾ï¸ Sin anuncios. Â¡Gracias!'),
      vip:()=>{G.gems+=1000;G.coins+=50000;G.powerups.rodillo+=10;G.powerups.levadura+=10;G.powerups.batidora+=5;G.powerups.extra+=10;},
    };
    acts[item.action]?.();sfxWin();saveG();
    document.getElementById('sCoins').textContent=G.coins.toLocaleString();
    document.getElementById('sGems').textContent=G.gems;
    buildShop();showNotif(`âœ… Â¡${item.name} recibido! Â¡Gracias! ğŸ‚`);
  },1200);
}

// â”€â”€â”€ STATS â”€â”€â”€
function goStats(){
  hideAllPanels();hideAllScreens();showScreen('statsScreen');
  const lvls=Object.keys(G.bestScores).length;
  const stars=Object.values(G.starsEarned).reduce((a,b)=>a+b,0);
  const rows=[
    ['Recetas completadas',`${lvls}/900`],
    ['Rivales derrotados', `${G.rivalKills}/${RIVALS.length} ğŸ†`],
    ['Estrellas ganadas',  `${stars}â­`],
    ['Fusiones totales',   G.totalMerges.toLocaleString()],
    ['PuntuaciÃ³n total',   G.totalScore.toLocaleString()],
    ['Mejor combo',        `Ã—${G.bestCombo}`],
    ['Monedas ganadas',    G.coins.toLocaleString()],
    ['Racha de dÃ­as',      `${G.streak}ğŸ”¥`],
    ['CapÃ­tulo actual',    `${G.currentChapter}/10`],
  ];
  document.getElementById('statRows').innerHTML=rows.map(([l,v])=>
    `<div class="stat-row"><span class="sl">${l}</span><span class="sv">${v}</span></div>`).join('');
}

// â”€â”€â”€ DAILY â”€â”€â”€
const DAILY=[
  {day:1,icon:'ğŸ’°',val:'+200'},
  {day:2,icon:'ğŸ’',val:'+8'},
  {day:3,icon:'ğŸ‚',val:'Rodillo Ã—2'},
  {day:4,icon:'ğŸ’°',val:'+800'},
  {day:5,icon:'â¬†ï¸',val:'Levadura Ã—3'},
  {day:6,icon:'ğŸ’',val:'+25'},
  {day:7,icon:'ğŸŒŸ',val:'Â¡ESPECIAL! 100ğŸ’'},
];
function goDaily(){
  hideAllPanels();hideAllScreens();showScreen('dailyScreen');
  const today=new Date().toDateString();
  const grid3=document.getElementById('dailyGrid');grid3.innerHTML='';
  DAILY.forEach((r,i)=>{
    const claimed=G.streak>i;const isToday=G.streak===i&&G.lastLogin!==today;
    const d=document.createElement('div');
    d.className=`day-box${claimed?' claimed':''}${isToday?' today':''}`;
    d.innerHTML=`<div class="dl">DÃ­a ${i+1}</div><div class="di">${r.icon}</div><div class="dv">${r.val}</div>${claimed?'<div style="font-size:10px;color:#34d399">âœ“</div>':''}`;
    grid3.appendChild(d);
  });
  const alreadyClaimed=G.lastLogin===new Date().toDateString();
  const btn=document.getElementById('claimBtn');
  btn.textContent=alreadyClaimed?'âœ… YA RECOGIDO HOY':'ğŸ‚ RECOGER RECOMPENSA';
  btn.disabled=alreadyClaimed;btn.style.opacity=alreadyClaimed?.5:1;
}
function claimDaily(){
  const today=new Date().toDateString();
  if(G.lastLogin===today){showNotif('â° Â¡Vuelve maÃ±ana!');return;}
  G.lastLogin=today;G.streak=Math.min((G.streak||0)+1,7);
  const r=DAILY[(G.streak-1)%7];
  if(r.icon==='ğŸ’°')G.coins+=parseInt(r.val)||200;
  if(r.icon==='ğŸ’')G.gems+=parseInt(r.val)||8;
  if(r.icon==='ğŸ‚')G.powerups.rodillo+=2;
  if(r.icon==='â¬†ï¸')G.powerups.levadura+=3;
  if(r.icon==='ğŸŒŸ'){G.gems+=100;G.coins+=3000;}
  saveG();sfxWin();updateCurrBar();
  showNotif(`ğŸ DÃ­a ${G.streak}: ${r.icon} ${r.val} recibido!`);goDaily();
}

// â”€â”€â”€ PANELS â”€â”€â”€
function showPanel(id){const p=document.getElementById(id);p.classList.remove('hidden');requestAnimationFrame(()=>p.classList.add('show'));}
function hidePanel(id){const p=document.getElementById(id);p.classList.remove('show');setTimeout(()=>p.classList.add('hidden'),340);}
function hideAllPanels(){document.querySelectorAll('.panel-bg').forEach(p=>{p.classList.remove('show');p.classList.add('hidden');});}

// â”€â”€â”€ SCREENS â”€â”€â”€
function showScreen(id){document.getElementById(id)?.classList.remove('hidden');}
function hideAllScreens(){document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));}
function goMenu(){
  hideAllPanels();hideAllScreens();showScreen('menuScreen');updateCurrBar();
  // Update bakery badge
  const bakery=BAKERY_NAMES[Math.min(G.currentChapter-1,9)]||BAKERY_NAMES[0];
  const badge=document.getElementById('bakeryBadge');
  if(badge)badge.textContent=`${CHAPTERS[Math.min(G.currentChapter-1,29)].icon} ${bakery}`;
}
function updateCurrBar(){
  document.getElementById('mCoins').textContent=G.coins.toLocaleString();
  document.getElementById('mGems').textContent=G.gems;
}

// â”€â”€â”€ NOTIF â”€â”€â”€
let notifTimer;
function showNotif(msg){
  const el=document.getElementById('notif');el.textContent=msg;el.classList.add('show');
  clearTimeout(notifTimer);notifTimer=setTimeout(()=>el.classList.remove('show'),2700);
}

// â”€â”€â”€ MERGE POPUP â”€â”€â”€
function showMergePopup(x,y,ing,pts){
  const old=document.querySelector('.mpop');if(old)old.remove();
  const d=document.createElement('div');d.className='mpop';
  d.style.cssText=`left:${x}px;top:${y}px`;
  d.innerHTML=`<div class="mpop-em">${ing.e}</div><div class="mpop-nm">${ing.n.toUpperCase()}</div><div class="mpop-pt">+${pts.toLocaleString()}</div>${GM.combo>2?`<div class="mpop-combo">Â¡Combo Ã—${GM.combo}!</div>`:''}`;
  document.body.appendChild(d);setTimeout(()=>d.remove(),950);
}

// â”€â”€â”€ CANVAS BG â”€â”€â”€
const bgC=document.getElementById('bgC'),bgX=bgC.getContext('2d');
const ptC=document.getElementById('ptC'),ptX=ptC.getContext('2d');
let W,H,particles=[];



function resize(){
  W=window.innerWidth;H=window.innerHeight;
  bgC.width=W;bgC.height=H;ptC.width=W;ptC.height=H;
  initAnimBg();
}

// â”€ ANIMATED BG ELEMENTS â”€
let bgTime=0,bgStars=[],bgFloatEm=[],bgBlobs2=[];
const BLOB_COLS=['rgba(236,72,153,','rgba(168,85,247,','rgba(251,191,36,','rgba(59,130,246,','rgba(52,211,153,','rgba(244,63,94,'];
const FLOAT_EM=['ğŸ¬','ğŸ‚','ğŸ§','ğŸ©','ğŸ°','ğŸŒ¸','â­','âœ¨','ğŸ­','ğŸ¥','ğŸ«','ğŸ’'];
function initAnimBg(){
  bgStars=[];for(let i=0;i<80;i++)bgStars.push({x:Math.random()*W,y:Math.random()*H,r:.4+Math.random()*1.4,ph:Math.random()*Math.PI*2,sp:.02+Math.random()*.04});
  bgBlobs2=[];for(let i=0;i<6;i++)bgBlobs2.push({x:Math.random()*W,y:Math.random()*H,r:100+Math.random()*200,c:BLOB_COLS[i%6],vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,ph:Math.random()*Math.PI*2,sp:.005+Math.random()*.012});
  bgFloatEm=[];for(let i=0;i<14;i++)bgFloatEm.push({x:Math.random()*W,y:Math.random()*H+H,em:FLOAT_EM[~~(Math.random()*FLOAT_EM.length)],sz:14+Math.random()*20,vy:-(0.25+Math.random()*.45),vx:(Math.random()-.5)*.3,a:.1+Math.random()*.16,rot:Math.random()*Math.PI*2,rs:(Math.random()-.5)*.015});
}
function drawBg(){
  bgTime+=.008;
  const h1=280+Math.sin(bgTime*.3)*20,h2=320+Math.cos(bgTime*.25)*25;
  const grd=bgX.createLinearGradient(0,0,W,H);
  grd.addColorStop(0,`hsl(${h1},60%,6%)`);grd.addColorStop(.5,`hsl(${(h1+h2)/2},55%,8%)`);grd.addColorStop(1,`hsl(${h2},58%,5%)`);
  bgX.fillStyle=grd;bgX.fillRect(0,0,W,H);
  bgBlobs2.forEach(b=>{
    b.ph+=b.sp;b.x+=b.vx+Math.sin(b.ph)*.4;b.y+=b.vy+Math.cos(b.ph*.7)*.3;
    if(b.x<-b.r)b.x=W+b.r;if(b.x>W+b.r)b.x=-b.r;if(b.y<-b.r)b.y=H+b.r;if(b.y>H+b.r)b.y=-b.r;
    const pulse=.08+.06*Math.sin(b.ph*2);
    const g=bgX.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r*(1+Math.sin(b.ph)*.15));
    g.addColorStop(0,b.c+(pulse+.05)+')'  );g.addColorStop(.6,b.c+(pulse*.3)+')');g.addColorStop(1,'rgba(0,0,0,0)');
    bgX.fillStyle=g;bgX.beginPath();bgX.arc(b.x,b.y,b.r*1.2,0,Math.PI*2);bgX.fill();
  });
  bgStars.forEach(s=>{s.ph+=s.sp;const a=.12+.55*Math.abs(Math.sin(s.ph));bgX.beginPath();bgX.arc(s.x,s.y,s.r,0,Math.PI*2);bgX.fillStyle=`rgba(255,210,255,${a})`;bgX.fill();});
  const sx=((bgTime*.09)%1.4-.2)*W;const sg=bgX.createLinearGradient(sx-60,0,sx+60,H);sg.addColorStop(0,'rgba(255,170,255,0)');sg.addColorStop(.5,'rgba(255,170,255,.022)');sg.addColorStop(1,'rgba(255,170,255,0)');bgX.fillStyle=sg;bgX.fillRect(0,0,W,H);
  bgX.save();bgFloatEm.forEach(f=>{f.y+=f.vy;f.x+=f.vx;f.rot+=f.rs;if(f.y<-60){f.y=H+30;f.x=Math.random()*W;}bgX.save();bgX.globalAlpha=f.a*(0.7+.3*Math.sin(bgTime+f.rot));bgX.translate(f.x,f.y);bgX.rotate(f.rot);bgX.font=f.sz+'px serif';bgX.textAlign='center';bgX.textBaseline='middle';bgX.fillText(f.em,0,0);bgX.restore();});bgX.restore();
}

function spawnPt(x,y,color,count){
  for(let i=0;i<count;i++){
    const a=(Math.PI*2/count)*i+Math.random()*.5,sp=2+Math.random()*5;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:.025+Math.random()*.03,r:2+Math.random()*5,color,type:i%4===0?'ring':'dot'});
  }
  for(let i=0;i<5;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*3;particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,life:.8,decay:.04,r:1+Math.random()*3,color:'#fff',type:'dot'});}
}
function drawPt(){
  ptX.clearRect(0,0,W,H);
  particles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.08;p.vx*=.97;p.vy*=.97;p.life-=p.decay;
    if(p.life<=0)return;
    ptX.globalAlpha=p.life;
    if(p.type==='ring'){ptX.beginPath();ptX.arc(p.x,p.y,p.r*p.life+2,0,Math.PI*2);ptX.strokeStyle=p.color;ptX.lineWidth=1.5;ptX.stroke();}
    else{ptX.beginPath();ptX.arc(p.x,p.y,p.r,0,Math.PI*2);ptX.fillStyle=p.color;ptX.fill();}
    ptX.globalAlpha=1;
  });
  particles=particles.filter(p=>p.life>0);
}
let raf;function bgLoop(){raf=requestAnimationFrame(bgLoop);drawBg();drawPt();}

// â”€â”€â”€ AUDIO â”€â”€â”€
let ac2;
function ac(){if(!ac2)ac2=new(window.AudioContext||window.webkitAudioContext)();return ac2;}
function tone(f,t,v=.12,type='sine'){try{const o=ac().createOscillator(),g=ac().createGain();o.connect(g);g.connect(ac().destination);o.type=type;o.frequency.value=f;g.gain.setValueAtTime(v,ac().currentTime);g.gain.exponentialRampToValueAtTime(.001,ac().currentTime+t);o.start();o.stop(ac().currentTime+t);}catch(e){}}
const sfxT=()=>tone(600,.08,.08,'sine');
const sfxMerge=(tier)=>{tone(350+tier*60,.18,.12,'sine');tone(500+tier*80,.12,.08,'triangle');};
const sfxBig=()=>{tone(880,.25,.15);setTimeout(()=>tone(1100,.2,.12),100);};
const sfxFail=()=>tone(180,.3,.1,'sawtooth');
const sfxWin=()=>{[523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>tone(f,.25,.1),i*90));};
const sfxCoin=()=>{tone(1400,.08,.07);setTimeout(()=>tone(1760,.08,.05),70);};
const sfxPu=()=>{tone(700,.15,.1,'square');};

// â”€â”€â”€ INIT â”€â”€â”€
window.addEventListener('resize',()=>{resize();if(!document.getElementById('gameScreen')?.classList.contains('hidden'))renderGrid();});
loadG();resize();bgLoop();updateCurrBar();

// Wire menu buttons via addEventListener (more reliable than onclick in iframe environments)
// Menu buttons - multiple binding methods for maximum compatibility
['btnHornear','btnTienda','btnLibro','btnDiario'].forEach((id,i)=>{
  const fn=[goChapters,goShop,goStats,goDaily][i];
  const el=document.getElementById(id);
  if(!el)return;
  el.addEventListener('click',fn);
  el.addEventListener('touchend',ev=>{ev.preventDefault();fn();},{passive:false});
});

const firstStory=ALL_STORIES[1];
if(G.unlocked===1&&!G.storiesSeen[1]&&firstStory){
  G.storiesSeen[1]=true;saveG();
  showStory(firstStory,()=>{hideAllScreens();showScreen('menuScreen');updateCurrBar();});
} else {
  showScreen('menuScreen');
}

if(G.lastLogin!==new Date().toDateString()&&G.unlocked>1)
  setTimeout(()=>showNotif('ğŸ Â¡Tu recompensa diaria te espera!'),1800);
</script>
</body>
</html>
